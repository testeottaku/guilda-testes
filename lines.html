<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Lines - Guild Manager</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/lucide@latest"></script>
  <script>
    tailwind.config = { theme: { extend: { colors: { emerald: { 50:'#ecfdf5', 100:'#d1fae5', 200:'#a7f3d0', 400:'#34d399', 500:'#10b981', 600:'#059669', 700:'#047857'} } } } }
  </script>
  <link rel="stylesheet" href="./style.css" />
</head>
<body class="bg-gray-50/80">

  <div class="flex min-h-screen">
    <!-- Menu Mobile Overlay -->
    <div id="sidebar-overlay" class="fixed inset-0 bg-black/30 z-40 hidden lg:hidden"></div>

    <!-- Sidebar -->
    <aside id="sidebar" class="fixed top-0 left-0 h-full w-72 bg-white border-r border-gray-200 z-50 transform -translate-x-full transition-transform duration-300 lg:translate-x-0 lg:static">
      <div class="flex items-center justify-between p-5 border-b border-gray-100">
        <div class="flex items-center gap-3">
          <div class="w-10 h-10 bg-gradient-to-br from-emerald-500 to-green-600 rounded-xl flex items-center justify-center shadow-lg shadow-green-200 text-white">
            <i data-lucide="shield" class="w-5 h-5"></i>
          </div>
          <div><h1 class="font-bold text-gray-900 text-lg">Guilda e eventos</h1><p class="text-xs text-gray-400">Painel</p></div>
        </div>
      </div>

      <nav class="p-4 space-y-1">
        <a href="dashboard.html" class="w-full flex items-center gap-3 px-4 py-3 rounded-xl text-sm font-medium text-gray-500 hover:bg-gray-50 hover:text-gray-700 transition-colors">
          <i data-lucide="house" class="w-5 h-5"></i> Dashboard
        </a>
        <a href="membros.html" class="w-full flex items-center gap-3 px-4 py-3 rounded-xl text-sm font-medium text-gray-500 hover:bg-gray-50 hover:text-gray-700 transition-colors">
          <i data-lucide="users" class="w-5 h-5"></i> Membros
        </a>
        <a href="lines.html" class="w-full flex items-center gap-3 px-4 py-3 rounded-xl text-sm font-medium bg-emerald-50 text-emerald-700 shadow-sm">
          <i data-lucide="layers" class="w-5 h-5"></i> Lines
        </a>
        <a href="ajustes.html" class="w-full flex items-center gap-3 px-4 py-3 rounded-xl text-sm font-medium text-gray-500 hover:bg-gray-50 hover:text-gray-700 transition-colors">
          <i data-lucide="sliders" class="w-5 h-5"></i> Ajustes
        </a>
        <a href="upgrade.html" class="w-full flex items-center gap-3 px-4 py-3 rounded-xl text-sm font-medium text-gray-500 hover:bg-gray-50 hover:text-gray-700 transition-colors">
          <i data-lucide="sparkles" class="w-5 h-5"></i> Upgrade
        </a>
        <a href="camp.html" class="only-leader w-full flex items-center gap-3 px-4 py-3 rounded-xl text-sm font-medium text-gray-500 hover:bg-gray-50 hover:text-gray-700 transition-colors">
          <i data-lucide="trophy" class="w-5 h-5"></i> Campeonato
        </a>
        <a href="admin.html" class="only-leader w-full flex items-center gap-3 px-4 py-3 rounded-xl text-sm font-medium text-gray-500 hover:bg-gray-50 hover:text-gray-700 transition-colors">
          <i data-lucide="settings" class="w-5 h-5"></i> Admin
        </a>
        <a id="nav-chefe" href="chefe.html" class="hidden w-full flex items-center gap-3 px-4 py-3 rounded-xl text-sm font-medium text-gray-500 hover:bg-gray-50 hover:text-gray-700 transition-colors">
          <i data-lucide="crown" class="w-5 h-5"></i> Chefe
        </a>
      </nav>

      
      <div class="absolute bottom-0 left-0 right-0 p-4 border-t border-gray-100">
        <div class="flex items-center justify-between px-3 py-2">
          <div class="flex items-center gap-3">
            <div class="w-8 h-8 rounded-full bg-emerald-100 flex items-center justify-center text-emerald-700 font-bold text-sm">A</div>
            <div>
              <p id="user-role" class="text-sm font-medium text-gray-700">Carregando...</p>
              <p id="user-email" class="text-xs text-gray-400 truncate w-24">...</p>
            </div>
          </div>
          <button id="btn-logout" class="p-2 text-gray-400 hover:text-red-500 transition-colors" title="Sair">
            <i data-lucide="log-out" class="w-4 h-4"></i>
          </button>
        </div>
      </div>
    </aside>

    <!-- Main -->
    <main class="flex-1 lg:ml-0">
      <!-- Topbar -->
      <header class="sticky top-0 z-30 bg-white/70 backdrop-blur border-b border-gray-100">
        <div class="max-w-5xl mx-auto px-4 py-4 flex items-center justify-between gap-3">
          <div class="flex items-center gap-3">
            <button id="mobile-menu-btn" class="lg:hidden p-2 rounded-xl hover:bg-gray-100 text-gray-500">
              <i data-lucide="menu" class="w-5 h-5 text-gray-700"></i>
            </button>
            <div>
              <h2 class="text-lg font-extrabold text-gray-900 flex items-center gap-2">Lines <span id="plus-badge-lines" class="hidden inline-flex items-center rounded-full bg-purple-50 text-purple-700 ring-1 ring-purple-200 px-2 py-0.5 text-[10px] font-extrabold">PLUS</span></h2>
              <p class="text-gray-500 text-sm mt-1" id="lines-count">Carregando...</p>
            </div>
          </div>

          <button id="btn-new-line" title="Recurso PLUS" onclick="openLineModal()" class="flex items-center gap-2 px-4 py-2.5 bg-gradient-to-r from-emerald-500 to-green-600 text-white rounded-xl text-sm font-medium shadow-lg shadow-emerald-200 hover:shadow-xl hover:shadow-emerald-200 transition-all active:scale-95">
            <i data-lucide="plus" class="w-4 h-4"></i> <span class="hidden sm:inline">Adicionar</span>
          </button>
        </div>

        <div class="max-w-5xl mx-auto px-4 pb-4 flex gap-3">
          <div class="flex-1 relative">
            <i data-lucide="search" class="absolute left-3.5 top-1/2 -translate-y-1/2 w-4 h-4 text-gray-400"></i>
            <input type="text" id="search-input" placeholder="Buscar por nome, nick ou ID..." class="w-full pl-10 pr-4 py-3 rounded-xl border border-gray-200 focus:border-emerald-500 focus:ring-2 focus:ring-emerald-100 outline-none text-sm transition-all bg-white">
          </div>
          <button id="btn-refresh-lines" onclick="loadLines(true)" class="flex items-center gap-2 px-4 py-3 rounded-xl border border-gray-200 bg-white text-sm text-gray-600 hover:bg-gray-50 transition-colors" title="Atualizar">↻</button>
        </div>
      </header>

      <div class="max-w-5xl mx-auto px-4 py-6">
        <div id="lines-list" class="space-y-3">
          <div class="bg-white rounded-2xl border border-gray-100 p-4 animate-pulse flex items-center gap-3">
            <div class="w-11 h-11 bg-gray-200 rounded-full"></div>
            <div class="flex-1 space-y-2">
              <div class="h-4 bg-gray-200 rounded w-1/3"></div>
              <div class="h-3 bg-gray-100 rounded w-1/4"></div>
            </div>
          </div>
        </div>
      </div>
    </main>
  </div>

  <!-- MODAL Line (Adicionar/Editar) -->
  <div id="line-modal" class="fixed inset-0 z-50 flex items-end sm:items-center justify-center hidden">
    <div class="fixed inset-0 bg-black/40" onclick="closeLineModal()"></div>
    <div class="relative bg-white w-full sm:max-w-md sm:rounded-2xl rounded-t-2xl max-h-[90vh] overflow-y-auto shadow-2xl animate-in">
      <div class="sticky top-0 bg-white border-b border-gray-100 p-4 flex items-center justify-between rounded-t-2xl z-10">
        <h3 id="line-modal-title" class="text-lg font-bold text-gray-900">Nova Line</h3>
        <button onclick="closeLineModal()" class="p-2 rounded-lg hover:bg-gray-100 transition-colors">
          <i data-lucide="x" class="w-5 h-5 text-gray-500"></i>
        </button>
      </div>

      <div class="p-4 space-y-4">
        <div>
          <label class="text-xs font-bold text-gray-600 ml-1">Nome (opcional)</label>
          <input id="line-name" type="text" class="w-full px-4 py-3 rounded-xl border border-gray-200 outline-none text-sm focus:border-emerald-500 focus:ring-2 focus:ring-emerald-100 transition-all" placeholder="Ex: Line Rush" />
        </div>

        <div class="bg-gray-50 rounded-2xl p-3 border border-gray-100">
          <div class="flex items-center justify-between">
            <p class="text-sm font-bold text-gray-800">Membros (máx. 4)</p>
            <span id="selected-count" class="text-xs text-gray-400">0/4</span>
          </div>

          <div id="selected-members" class="mt-3 space-y-2"></div>

          <div class="mt-3">
            <label class="text-xs font-bold text-gray-600 ml-1">Adicionar membro</label>
            <select id="member-picker" class="w-full mt-1 px-4 py-3 rounded-xl border border-gray-200 bg-white outline-none text-sm focus:border-emerald-500 focus:ring-2 focus:ring-emerald-100 transition-all">
              <option value="">Selecione um membro...</option>
            </select>
            <button onclick="addPickedMember()" class="mt-2 w-full py-2.5 rounded-xl bg-white border border-gray-200 text-sm font-medium text-gray-700 hover:bg-gray-50 transition-colors">Adicionar</button>
          </div>
        </div>

        <div class="flex gap-2 pt-1">
          <button id="btn-save-line" onclick="saveLine()" class="flex-1 py-3 rounded-xl bg-gradient-to-r from-emerald-500 to-green-600 text-white font-bold text-sm shadow-lg shadow-emerald-200 hover:shadow-xl hover:shadow-emerald-200 transition-all active:scale-95">Salvar</button>
          <button id="btn-delete-line" onclick="deleteLine()" class="hidden flex-1 py-3 rounded-xl border border-red-200 text-red-600 font-bold text-sm hover:bg-red-50 transition-colors">Excluir</button>
        </div>
      </div>
    </div>
  </div>

  <!-- MODAL Detalhe do Membro (visual) -->
  <div id="member-view-modal" class="fixed inset-0 z-50 flex items-end sm:items-center justify-center hidden">
    <div class="fixed inset-0 bg-black/40" onclick="closeMemberView()"></div>
    <div class="relative bg-white w-full sm:max-w-md sm:rounded-2xl rounded-t-2xl max-h-[90vh] overflow-y-auto shadow-2xl animate-in">
      <div class="sticky top-0 bg-white border-b border-gray-100 p-4 flex items-center justify-between rounded-t-2xl z-10">
        <h3 class="text-lg font-bold text-gray-900">Membro</h3>
        <button onclick="closeMemberView()" class="p-2 rounded-lg hover:bg-gray-100 transition-colors">
          <i data-lucide="x" class="w-5 h-5 text-gray-500"></i>
        </button>
      </div>
      <div id="member-view-body" class="p-4"></div>
    </div>
  </div>

  <script type="module">

    import { checkAuth, setupSidebar, initIcons, logout, db, showToast, getGuildContext } from './logic.js';
    import { collection, getDocs, doc, setDoc, updateDoc, deleteDoc, serverTimestamp, addDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    setupSidebar();
    initIcons();

    function tierRank(t){
      const s=(t||'free').toString().toLowerCase();
      if(s==='pro' || s==='business') return 2; if(s==='plus') return 1; return 0;
    }
    function applyVip(tier){
      const rank = tierRank(tier);
      const badge = document.getElementById('plus-badge-lines');

      // FREE = mostra tag PLUS
      if(rank === 0){
        if(badge) badge.classList.remove('hidden');
      } else {
        if(badge) badge.classList.add('hidden');
      }
    }

    // ---- Estado ------------------------------------------------------------
    let guildId = null;
    let members = [];        // cache local de membros (para picker / snapshots)
    let lines = [];          // lista de lines renderizada
    let editingLineId = null;
    let selectedMemberIds = []; // para modal

    // Cache keys (por guilda)
    const ctx = getGuildContext();
    if (ctx?.guildId) guildId = ctx.guildId;

    const keyLines = () => guildId ? `linesList_${guildId}` : 'linesList';
    const keyMembers = () => 'membersList'; // já existe no projeto

    // Controle de UI (evita salvar antes do ctx/auth resolver)
    function setUiReady(ready) {
      const bNew = document.getElementById('btn-new-line');
      const bRef = document.getElementById('btn-refresh-lines');
      [bNew, bRef].forEach(b => {
        if (!b) return;
        b.disabled = !ready;
        b.classList.toggle('opacity-50', !ready);
        b.classList.toggle('pointer-events-none', !ready);
      });
    }

    setUiReady(!!guildId);


    // ---- Utilitários --------------------------------------------------------
    const normalize = (s) => (s || '').toString().toLowerCase().trim();
    const uniq = (arr) => Array.from(new Set((arr || []).filter(Boolean).map(String)));

    function setCount() {
      const el = document.getElementById('lines-count');
      if (!el) return;
      el.textContent = `${lines.length} line${lines.length === 1 ? '' : 's'}`;
    }

    function calcNextNumber() {
      const nums = lines.map(l => Number(l.number || 0)).filter(n => Number.isFinite(n));
      const max = nums.length ? Math.max(...nums) : 0;
      return max + 1;
    }

    function getDisplayName(line) {
      const n = (line.name || '').toString().trim();
      if (n) return n;
      const num = Number(line.number || 0) || 0;
      return num ? `Line ${num}` : 'Line';
    }

    function badge(text, icon) {
      if (!text && text !== 0) return '';
      return `<span class="inline-flex items-center gap-1 px-2 py-1 rounded-lg bg-gray-100 text-gray-600 text-[10px] font-bold">
        <i data-lucide="${icon}" class="w-3.5 h-3.5"></i>${text}
      </span>`;
    }

    function detailBox(label, ok, meta) {
      const v = (ok === true || ok === 'Sim' || ok === 'sim') ? 'Sim' : (ok === false || ok === 'Não' || ok === 'nao' || ok === 'não') ? 'Não' : (ok || '-');
      const cls = (v === 'Sim') ? 'text-emerald-600' : (v === 'Não') ? 'text-red-500' : 'text-gray-700';
      return `<div class="bg-white rounded-xl p-3 border border-gray-100">
        <p class="text-xs text-gray-400 mb-1">${label}</p>
        <p class="text-xs font-bold ${cls}">${v}${meta ? ` • <span class="text-gray-400 font-semibold">${meta}</span>` : ''}</p>
      </div>`;
    }

    function mapMemberSnap(m) {
      // tenta manter compatível com membros.html
      return {
        id: (m.id || '').toString(),
        nick: (m.nick || m.nickname || '').toString(),
        visibleId: (m.visibleId || m.playerId || m.uid || m.id || '').toString(),
        whatsapp: (m.whatsapp || '').toString(),
        guildWar: m.guildWar ?? m.guerra ?? null,
        guildWarMeta: (m.guildWarMeta || '').toString(),
        weeklyMeta: m.weeklyMeta ?? null,
        weeklyMetaValue: (m.weeklyMetaValue || '').toString(),
        hasTag: m.hasTag ?? null
      };
    }

    function getMemberById(id) {
      const sid = String(id || '');
      return members.find(x => String(x.id) === sid) || null;
    }

    function computeMembersUsedInLines(allLines) {
      const used = new Set();
      for (const l of (allLines || [])) {
        const arr = (l.members || l.memberIds || []);
        for (const it of arr) {
          if (typeof it === 'string') used.add(it);
          else if (it && it.id) used.add(String(it.id));
        }
      }
      return used;
    }

    // ---- Render -------------------------------------------------------------
    function renderLines(list) {
      const el = document.getElementById('lines-list');
      if (!el) return;

      if (!Array.isArray(list) || list.length === 0) {
        el.innerHTML = `<div class="bg-white rounded-2xl p-8 border border-gray-100 text-center text-gray-400 text-sm">0 lines.</div>`;
        lines = [];
        setCount();
        initIcons();
        return;
      }

      lines = list;
      setCount();

      el.innerHTML = list.map(l => {
        const name = getDisplayName(l);
        const memArr = (l.members || []).map(x => (typeof x === 'string') ? (getMemberById(x) ? mapMemberSnap(getMemberById(x)) : {id:x, nick:'', visibleId:''}) : x);
        const count = memArr.length;
        const preview = memArr.slice(0, 4);

        return `
          <div class="bg-white rounded-2xl border border-gray-100 shadow-sm overflow-hidden transition-all hover:shadow-md animate-in">
            <div class="w-full flex items-center gap-3 p-4 cursor-pointer" onclick="toggleLineDetails('${l.id}')">
              <div class="w-11 h-11 rounded-full bg-gradient-to-br from-emerald-400 to-green-500 flex items-center justify-center flex-shrink-0 text-white font-bold text-sm">
                ${name.charAt(0).toUpperCase()}
              </div>
              <div class="flex-1 min-w-0">
                <p class="font-semibold text-gray-900 text-sm truncate">${name}</p>
                <p class="text-xs text-gray-400">${count}/4 membros</p>
              </div>
              <div class="flex gap-1.5">
                ${badge(`Line ${Number(l.number||0)||'—'}`, 'hash')}
                ${badge(`${count}/4`, 'users')}
              </div>
              <div class="text-gray-300"><i data-lucide="chevron-down" class="w-5 h-5"></i></div>
            </div>

            <div id="line-details-${l.id}" class="hidden border-t border-gray-100 p-4 bg-gray-50/50 space-y-3">
              <div class="grid grid-cols-2 gap-3">
                <div class="bg-white rounded-xl p-3 border border-gray-100">
                  <p class="text-xs text-gray-400 mb-1">Nome</p>
                  <p class="text-xs font-bold text-gray-800 truncate">${name}</p>
                </div>
                <div class="bg-white rounded-xl p-3 border border-gray-100">
                  <p class="text-xs text-gray-400 mb-1">Participantes</p>
                  <p class="text-xs font-bold text-gray-800">${count}/4</p>
                </div>
              </div>

              <div class="space-y-2">
                ${preview.length ? preview.map(m => `
                  <button class="w-full text-left bg-white rounded-2xl border border-gray-100 p-3 flex items-center gap-3 hover:bg-gray-50 transition-colors" onclick="openMemberView('${m.id}')">
                    <div class="w-10 h-10 rounded-full bg-gradient-to-br from-emerald-400 to-green-500 flex items-center justify-center text-white font-bold text-xs">${(m.nick||'?').charAt(0).toUpperCase()}</div>
                    <div class="flex-1 min-w-0">
                      <p class="text-sm font-semibold text-gray-900 truncate">${m.nick || 'Sem Nick'}</p>
                      <p class="text-xs text-gray-400 truncate">ID: ${m.visibleId || m.id || '-'}</p>
                    </div>
                    <i data-lucide="chevron-right" class="w-5 h-5 text-gray-300"></i>
                  </button>
                `).join('') : `<div class="text-sm text-gray-400 text-center py-3">Sem membros na line.</div>`}
              </div>

              <div class="flex gap-2 pt-2">
                <button onclick="editLine('${l.id}')" class="flex-1 py-2.5 rounded-xl border border-emerald-200 text-emerald-700 font-bold text-sm hover:bg-emerald-50 transition-colors">Editar</button>
              </div>
            </div>
          </div>
        `;
      }).join('');

      initIcons();
    }

    window.toggleLineDetails = (id) => {
      const el = document.getElementById(`line-details-${id}`);
      if (!el) return;
      el.classList.toggle('hidden');
      initIcons();
    };

    // ---- Cache --------------------------------------------------------------
    function loadCached() {
      try {
        const rawM = localStorage.getItem(keyMembers());
        if (rawM) {
          const arr = JSON.parse(rawM);
          if (Array.isArray(arr)) members = arr;
        }
      } catch(_) {}

      if (!guildId) return;

      try {
        const raw = localStorage.getItem(keyLines());
        if (!raw) return;
        const cached = JSON.parse(raw);
        if (Array.isArray(cached)) renderLines(cached);
      } catch(_) {}
    }

    function saveCached(list) {
      if (!guildId) return;
      try { localStorage.setItem(keyLines(), JSON.stringify(list || [])); } catch(_) {}
    }

    // ---- Firestore ----------------------------------------------------------
    async function fetchMembersFromDB() {
      if (!guildId) return;
      try {
        const snap = await getDocs(collection(db, 'guildas', guildId, 'membros'));
        const arr = snap.docs.map(d => ({ id: d.id, ...d.data() }));
        // mantém no mesmo cache usado na tela de membros (ajuda a seleção aqui e lá)
        members = arr;
        try { localStorage.setItem(keyMembers(), JSON.stringify(arr)); } catch(_) {}
      } catch (e) {
        console.warn('fetchMembersFromDB', e);
      }
    }

    async function fetchLinesFromDB() {
      if (!guildId) return [];
      const snap = await getDocs(collection(db, 'guildas', guildId, 'lines'));
      const arr = snap.docs.map(d => ({ id: d.id, ...d.data() }));
      // garante shape
      return arr.map((l) => ({
        id: l.id,
        name: (l.name || '').toString(),
        number: Number(l.number || 0) || 0,
        members: Array.isArray(l.members) ? l.members : [],
        memberIds: Array.isArray(l.memberIds) ? l.memberIds : []
      })).sort((a,b) => (a.number||0) - (b.number||0));
    }

    // ---- Load principal -----------------------------------------------------
    window.loadLines = async (force=false) => {
      try {
        if (!guildId) {
          const c = getGuildContext();
          if (c?.guildId) guildId = c.guildId;
        }
        if (!guildId) return;

        if (force) showToast('info', 'Atualizando...');
        // garante membros para picker (se não tiver)
        if (!Array.isArray(members) || members.length === 0) {
          await fetchMembersFromDB();
        }
        const arr = await fetchLinesFromDB();
        renderLines(arr);
        saveCached(arr);
        if (force) showToast('success', 'Atualizado!');
      } catch (e) {
        console.warn(e);
        if (force) showToast('error', 'Falha ao atualizar.');
      }
    };

    // ---- Modal de Line ------------------------------------------------------
    function updatePickerOptions() {
      const picker = document.getElementById('member-picker');
      if (!picker) return;

      const used = computeMembersUsedInLines(lines);
      // Durante edição, membros já selecionados na line podem continuar aparecendo.
      for (const id of selectedMemberIds) used.delete(String(id));

      const available = (members || []).filter(m => m?.id && !used.has(String(m.id)) && !selectedMemberIds.includes(String(m.id)));

      picker.innerHTML = `<option value="">Selecione um membro...</option>` + available
        .sort((a,b) => normalize(a.nick).localeCompare(normalize(b.nick)))
        .map(m => `<option value="${m.id}">${(m.nick || 'Sem Nick')} • ID: ${(m.visibleId || m.id)}</option>`).join('');
    }

    function renderSelected() {
      const box = document.getElementById('selected-members');
      const countEl = document.getElementById('selected-count');
      if (countEl) countEl.textContent = `${selectedMemberIds.length}/4`;

      if (!box) return;
      if (selectedMemberIds.length === 0) {
        box.innerHTML = `<div class="text-sm text-gray-400 text-center py-2">Nenhum membro selecionado.</div>`;
        updatePickerOptions();
        return;
      }

      box.innerHTML = selectedMemberIds.map(id => {
        const m = getMemberById(id) || { id, nick: '', visibleId: id };
        return `
          <div class="bg-white rounded-2xl border border-gray-100 p-3 flex items-center gap-3">
            <div class="w-10 h-10 rounded-full bg-gradient-to-br from-emerald-400 to-green-500 flex items-center justify-center text-white font-bold text-xs">${(m.nick || '?').charAt(0).toUpperCase()}</div>
            <div class="flex-1 min-w-0">
              <p class="text-sm font-semibold text-gray-900 truncate">${m.nick || 'Sem Nick'}</p>
              <p class="text-xs text-gray-400 truncate">ID: ${(m.visibleId || m.id || '-')}</p>
            </div>
            <button class="p-2 rounded-xl hover:bg-gray-50" onclick="removeSelectedMember('${id}')">
              <i data-lucide="trash-2" class="w-4 h-4 text-red-400"></i>
            </button>
          </div>
        `;
      }).join('');
      updatePickerOptions();
      initIcons();
    }

    window.openLineModal = async () => {
      editingLineId = null;
      selectedMemberIds = [];

      // garante guildId/members
      if (!guildId) {
        const c = getGuildContext();
        if (c?.guildId) guildId = c.guildId;
      }
      if (!guildId) {
        showToast('error', 'Guilda não resolvida. Faça login novamente.');
        return;
      }
      if (!Array.isArray(members) || members.length === 0) await fetchMembersFromDB();

      document.getElementById('line-modal-title').textContent = 'Nova Line';
      document.getElementById('line-name').value = '';
      document.getElementById('btn-delete-line').classList.add('hidden');

      document.getElementById('line-modal').classList.remove('hidden');
      renderSelected();
    };

    window.closeLineModal = () => {
      document.getElementById('line-modal').classList.add('hidden');
    };

    window.addPickedMember = () => {
      const picker = document.getElementById('member-picker');
      const id = picker?.value;
      if (!id) return;

      if (selectedMemberIds.length >= 4) {
        showToast('error', 'Máximo de 4 membros por line.');
        return;
      }
      selectedMemberIds.push(String(id));
      selectedMemberIds = uniq(selectedMemberIds).slice(0,4);
      picker.value = '';
      renderSelected();
    };

    window.removeSelectedMember = (id) => {
      selectedMemberIds = selectedMemberIds.filter(x => String(x) !== String(id));
      renderSelected();
    };

    window.editLine = async (id) => {
      const line = lines.find(l => String(l.id) === String(id));
      if (!line) return;

      editingLineId = line.id;
      const name = (line.name || '').toString().trim();
      document.getElementById('line-modal-title').textContent = 'Editar Line';
      document.getElementById('line-name').value = name;

      const memArr = Array.isArray(line.members) ? line.members : [];
      selectedMemberIds = uniq(memArr.map(x => (typeof x === 'string') ? x : (x?.id))).slice(0,4);

      document.getElementById('btn-delete-line').classList.remove('hidden');
      document.getElementById('line-modal').classList.remove('hidden');
      renderSelected();
    };

    window.saveLine = async () => {
      if (!guildId) { showToast('info','Carregando sua guilda...'); return; }

      // Gate local (evita bypass via console)
      try {
        const raw = localStorage.getItem('guildCtx_cache_v1');
        const ctx = raw ? JSON.parse(raw) : null;
        const tier = (ctx?.vipTier || 'free').toString().toLowerCase();
        const isPlusOrPro = tier !== 'free';
        if (!isPlusOrPro) {
          showToast('warn', 'Recurso PLUS: faça upgrade para salvar Lines.');
          return;
        }
      } catch (_) {}
      try {
        if (!guildId) {
          const c = getGuildContext();
          if (c?.guildId) guildId = c.guildId;
        }
        if (!guildId) throw new Error('Guilda não resolvida.');

        // validações
        selectedMemberIds = uniq(selectedMemberIds);
        if (selectedMemberIds.length === 0) {
          showToast('error', 'Selecione pelo menos 1 membro.');
          return;
        }
        if (selectedMemberIds.length > 4) selectedMemberIds = selectedMemberIds.slice(0,4);

        // Verifica se alguém já está em outra line (exceto a line atual)
        const used = computeMembersUsedInLines(lines.filter(l => String(l.id) !== String(editingLineId)));
        const conflicts = selectedMemberIds.filter(id => used.has(String(id)));
        if (conflicts.length) {
          showToast('error', 'Um ou mais membros já estão em outra line.');
          return;
        }

        const rawName = (document.getElementById('line-name').value || '').toString().trim();
        let number = 0;

        if (editingLineId) {
          const existing = lines.find(l => String(l.id) === String(editingLineId));
          number = Number(existing?.number || 0) || 0;
        } else {
          number = calcNextNumber();
        }

        const memberSnaps = selectedMemberIds.map(id => mapMemberSnap(getMemberById(id) || { id }));

        const payload = {
          name: rawName,
          number,
          memberIds: selectedMemberIds,
          members: memberSnaps,
          updatedAt: serverTimestamp(),
        };

        if (!editingLineId) payload.createdAt = serverTimestamp();

        showToast('info', 'Salvando...');
        if (editingLineId) {
          await updateDoc(doc(db, 'guildas', guildId, 'lines', editingLineId), payload);
        } else {
          const ref = await addDoc(collection(db, 'guildas', guildId, 'lines'), payload);
          editingLineId = ref.id;
        }

        await loadLines(false);
        closeLineModal();
        showToast('success', 'Line salva!');
      } catch (e) {
        console.warn(e);
        showToast('error', 'Erro ao salvar a line.');
      }
    };

    window.deleteLine = async () => {
      try {
        if (!editingLineId) return;
        if (!guildId) {
          const c = getGuildContext();
          if (c?.guildId) guildId = c.guildId;
        }
        if (!guildId) throw new Error('Guilda não resolvida.');
        await deleteDoc(doc(db, 'guildas', guildId, 'lines', editingLineId));
        await loadLines(false);
        closeLineModal();
        showToast('success', 'Line excluída!');
      } catch(e) {
        console.warn(e);
        showToast('error', 'Erro ao excluir.');
      }
    };

    // ---- Pesquisa -----------------------------------------------------------
    function applySearch() {
      const q = normalize(document.getElementById('search-input')?.value || '');
      if (!q) {
        renderLines(lines);
        return;
      }
      const filtered = (lines || []).filter(l => {
        const name = normalize(getDisplayName(l));
        if (name.includes(q)) return true;

        const mem = Array.isArray(l.members) ? l.members : [];
        for (const it of mem) {
          const id = (typeof it === 'string') ? it : (it?.id || '');
          const m = (typeof it === 'string') ? getMemberById(id) : it;
          const nick = normalize(m?.nick || '');
          const vid = normalize(m?.visibleId || id);
          if (nick.includes(q) || vid.includes(q)) return true;
        }
        return false;
      });
      renderLines(filtered);
    }

    document.getElementById('search-input')?.addEventListener('input', applySearch);

    // ---- Visual do membro (igual estilo da tela de membros) -----------------
    window.openMemberView = (id) => {
      const m = getMemberById(id) || null;
      if (!m) {
        showToast('error', 'Membro não encontrado no cache. Atualize a lista de membros.');
        return;
      }
      const snap = mapMemberSnap(m);
      const body = document.getElementById('member-view-body');
      body.innerHTML = `
        <div class="bg-white rounded-2xl border border-gray-100 p-4 shadow-sm">
          <div class="flex items-center gap-3">
            <div class="w-12 h-12 rounded-full bg-gradient-to-br from-emerald-400 to-green-500 flex items-center justify-center text-white font-bold">${(snap.nick||'?').charAt(0).toUpperCase()}</div>
            <div class="min-w-0">
              <p class="text-base font-extrabold text-gray-900 truncate">${snap.nick || 'Sem Nick'}</p>
              <p class="text-xs text-gray-400">ID: ${snap.visibleId || snap.id || '-'}</p>
            </div>
          </div>

          <div class="mt-4 grid grid-cols-2 gap-3">
            ${detailBox('Guerra', snap.guildWar, snap.guildWarMeta)}
            ${detailBox('Meta Semanal', snap.weeklyMeta, snap.weeklyMetaValue)}
            <div class="bg-white rounded-xl p-3 border border-gray-100">
              <p class="text-xs text-gray-400 mb-1">Tag</p>
              ${snap.hasTag ? '<span class="text-emerald-500 font-bold text-xs">Sim</span>' : '<span class="text-red-400 text-xs">Não</span>'}
            </div>
            <div class="bg-white rounded-xl p-3 border border-gray-100">
              <p class="text-xs text-gray-400 mb-1">WhatsApp</p>
              ${snap.whatsapp ? `<a href="https://wa.me/55${snap.whatsapp}" target="_blank" class="text-emerald-600 text-xs hover:underline">${snap.whatsapp}</a>` : '<span class="text-xs text-gray-400">-</span>'}
            </div>
          </div>
        </div>
      `;
      document.getElementById('member-view-modal').classList.remove('hidden');
      initIcons();
    };

    window.closeMemberView = () => {
      document.getElementById('member-view-modal').classList.add('hidden');
    };

    // ---- Boot ---------------------------------------------------------------
    // 1) Renderiza cache imediatamente (sem piscar)
    loadCached();

    // 2) Auth e sync em background
    checkAuth().then(async () => {
      // refaz guildId pelo ctx já resolvido
      const c = getGuildContext();
      if (c?.guildId) guildId = c.guildId;
      setUiReady(!!guildId);
      const lo = document.getElementById('btn-logout');
      if (lo) lo.onclick = logout;

      await loadLines(false);
    });

  
  </script>
</body>
</html>
