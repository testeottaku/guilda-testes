<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Campeonato - Guilda</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
</head>
<body class="bg-gray-50 flex text-gray-800 font-sans">

    <div class="lg:hidden fixed top-4 left-4 z-50">
        <button id="menu-btn" class="bg-white p-2 rounded-lg shadow text-emerald-600"><i data-lucide="menu"></i></button>
    </div>

    <aside id="sidebar" class="w-64 bg-white border-r h-screen fixed -translate-x-full lg:translate-x-0 transition-transform z-40">
        <div class="p-6 flex items-center gap-3 border-b">
            <div class="bg-emerald-500 text-white p-2 rounded-lg"><i data-lucide="shield"></i></div>
            <span class="font-bold">Painel Guilda</span>
        </div>
        <nav class="p-4 space-y-2">
            <a href="dashboard.html" class="flex gap-3 px-4 py-3 text-gray-500 hover:bg-gray-100 rounded-xl transition"><i data-lucide="layout-dashboard"></i> Dashboard</a>
            <a href="membros.html" class="flex gap-3 px-4 py-3 text-gray-500 hover:bg-gray-100 rounded-xl transition"><i data-lucide="users"></i> Membros</a>
            <a href="campeonato.html" class="flex gap-3 px-4 py-3 bg-emerald-50 text-emerald-700 rounded-xl font-medium"><i data-lucide="swords"></i> Campeonato</a>
            <a href="admin.html" class="flex gap-3 px-4 py-3 text-gray-500 hover:bg-gray-100 rounded-xl transition"><i data-lucide="settings"></i> Admin</a>
            <button onclick="window.authApi.logout().then(()=>location.href='index.html')" class="w-full flex gap-3 px-4 py-3 text-red-500 hover:bg-red-50 rounded-xl mt-10"><i data-lucide="log-out"></i> Sair</button>
        </nav>
    </aside>

    <main class="flex-1 lg:ml-64 min-h-screen p-6">
        <header class="bg-white/80 backdrop-blur border-b p-4 mb-6 rounded-2xl flex justify-between items-center sticky top-0 z-30">
            <h1 class="font-bold text-lg flex items-center gap-2"><i data-lucide="swords" class="text-emerald-500"></i> Gestão de Guerra</h1>
        </header>

        <div class="bg-white rounded-2xl shadow-sm border overflow-hidden">
            <div class="overflow-x-auto">
                <table class="w-full text-left text-sm">
                    <thead class="bg-gray-50 text-gray-500 border-b">
                        <tr>
                            <th class="p-4 font-bold">Nick</th>
                            <th class="p-4 font-bold">ID</th>
                            <th class="p-4 font-bold">Participa?</th>
                            <th class="p-4 font-bold">Pontuação</th>
                            <th class="p-4 font-bold text-right">Ação</th>
                        </tr>
                    </thead>
                    <tbody id="table-body" class="divide-y divide-gray-100">
                        <tr><td colspan="5" class="p-6 text-center text-gray-400">Carregando...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </main>

    <script type="module">
        import "./firebase.js";
        
        // Menu Mobile Logic
        document.getElementById('menu-btn').onclick = () => {
            const sb = document.getElementById('sidebar');
            sb.classList.toggle('-translate-x-full');
        };

        window.onload = async () => {
            if(!await window.authApi.check()) return;
            load();
        };

        async function load() {
            const members = await window.guildDB.getMembers();
            // Ordenar quem participa da guerra primeiro
            members.sort((a,b) => Number(b.guildWar) - Number(a.guildWar));
            
            const tbody = document.getElementById('table-body');
            tbody.innerHTML = "";
            
            members.forEach(m => {
                const tr = document.createElement('tr');
                tr.className = "hover:bg-gray-50 transition";
                tr.innerHTML = `
                    <td class="p-4 font-bold text-gray-900">${m.nick}</td>
                    <td class="p-4 text-gray-500 font-mono text-xs">${m.visibleId || '-'}</td>
                    <td class="p-4">
                        <span class="px-2 py-1 rounded-full text-xs font-bold ${m.guildWar ? 'bg-emerald-100 text-emerald-700' : 'bg-gray-100 text-gray-500'}">
                            ${m.guildWar ? 'Sim' : 'Não'}
                        </span>
                    </td>
                    <td class="p-4">
                        <input type="number" id="pts-${m.id}" value="${m.guildWarMeta || 0}" 
                               class="w-20 p-2 border rounded-lg text-center font-bold focus:border-emerald-500 outline-none">
                    </td>
                    <td class="p-4 text-right">
                        <button onclick="saveScore('${m.id}')" class="bg-emerald-500 hover:bg-emerald-600 text-white p-2 rounded-lg shadow-sm transition">
                            <i data-lucide="save" class="w-4 h-4"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
            lucide.createIcons();
        }

        window.saveScore = async (id) => {
            const val = document.getElementById(`pts-${id}`).value;
            try {
                // Atualiza apenas o campo da meta de guerra
                await window.guildDB.saveMember({ id: id, guildWarMeta: Number(val) });
                // Feedback visual rápido
                const btn = document.activeElement;
                const original = btn.innerHTML;
                btn.innerHTML = `<i data-lucide="check" class="w-4 h-4"></i>`;
                lucide.createIcons();
                setTimeout(() => { btn.innerHTML = original; lucide.createIcons(); }, 1500);
            } catch(err) { alert("Erro ao salvar"); }
        }
    </script>
</body>
</html>
