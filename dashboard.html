<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Guilda</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link rel="stylesheet" href="./style.css">
</head>
<body class="bg-gray-50 text-gray-900 font-sans h-screen flex overflow-hidden">

    <div id="sidebar-overlay" onclick="toggleMenu()" class="fixed inset-0 bg-black/30 z-40 hidden lg:hidden backdrop-blur-sm transition-opacity"></div>

    <aside id="sidebar" class="fixed top-0 left-0 h-full w-72 bg-white border-r border-gray-200 z-50 transform -translate-x-full lg:translate-x-0 flex flex-col transition-transform duration-300">
        
        <div class="flex items-center justify-between p-5 border-b border-gray-100">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 bg-gradient-to-br from-emerald-500 to-green-600 rounded-xl flex items-center justify-center shadow-lg shadow-green-200 text-white">
                    <i data-lucide="shield" class="w-5 h-5"></i>
                </div>
                <div>
                    <h1 class="font-bold text-gray-900 text-lg leading-tight">Guilda e eventos</h1>
                    <p class="text-xs text-gray-400">Painel Admin</p>
                </div>
            </div>
            <button onclick="toggleMenu()" class="lg:hidden text-gray-400 hover:text-gray-600">
                <i data-lucide="x" class="w-6 h-6"></i>
            </button>
        </div>

        <nav class="flex-1 p-4 space-y-1 overflow-y-auto">
            <a href="dashboard.html" class="flex items-center gap-3 px-4 py-3 rounded-xl text-sm font-medium bg-emerald-50 text-emerald-700 shadow-sm transition-all">
                <i data-lucide="layout-dashboard" class="w-5 h-5"></i> Dashboard
            </a>
            <a href="membros.html" class="flex items-center gap-3 px-4 py-3 rounded-xl text-sm font-medium text-gray-500 hover:bg-gray-50 hover:text-gray-700 transition-all">
                <i data-lucide="users" class="w-5 h-5"></i> Membros
            </a>
            <a href="campeonato.html" class="flex items-center gap-3 px-4 py-3 rounded-xl text-sm font-medium text-gray-500 hover:bg-gray-50 hover:text-gray-700 transition-all">
                <i data-lucide="trophy" class="w-5 h-5"></i> Campeonato
            </a>
            <a href="admin.html" class="flex items-center gap-3 px-4 py-3 rounded-xl text-sm font-medium text-gray-500 hover:bg-gray-50 hover:text-gray-700 transition-all">
                <i data-lucide="settings" class="w-5 h-5"></i> Admin
            </a>
        </nav>

        <div class="p-4 border-t border-gray-100 bg-white">
            <div class="flex items-center gap-3 px-2 py-1">
                <div class="w-9 h-9 rounded-full bg-emerald-100 flex items-center justify-center text-emerald-700 font-bold text-sm select-none">
                    <span id="user-initial">U</span>
                </div>
                <div class="flex-1 min-w-0">
                    <p class="text-sm font-bold text-gray-900 truncate" id="user-role-label">Carregando...</p>
                    <p class="text-xs text-gray-400 truncate" id="user-email">...</p>
                </div>
                <button onclick="window.authApi.logout()" class="text-gray-300 hover:text-red-500 transition-colors p-1" title="Sair">
                    <i data-lucide="log-out" class="w-5 h-5"></i>
                </button>
            </div>
        </div>
    </aside>

    <main class="flex-1 flex flex-col min-w-0 overflow-hidden bg-gray-50">
        
        <header class="lg:hidden bg-white/80 backdrop-blur border-b border-gray-200 px-4 py-3 flex items-center gap-3 sticky top-0 z-30">
            <button onclick="toggleMenu()" class="p-2 -ml-2 text-gray-600 hover:bg-gray-100 rounded-xl transition-colors">
                <i data-lucide="menu" class="w-6 h-6"></i>
            </button>
            <h1 class="font-bold text-gray-900 text-lg">Dashboard</h1>
        </header>

        <div class="flex-1 overflow-y-auto p-4 sm:p-6 lg:p-8">
            <div class="max-w-6xl mx-auto space-y-6 animate-in">
                
                <div class="hidden lg:block mb-6">
                    <h2 class="text-2xl font-bold text-gray-900">Visão Geral</h2>
                    <p class="text-gray-500 text-sm mt-1">Resumo das atividades da guilda</p>
                </div>

                <div id="loading" class="flex flex-col items-center justify-center py-20 text-gray-400">
                    <i data-lucide="loader-circle" class="w-8 h-8 animate-spin mb-3 text-emerald-500"></i>
                    <p class="text-sm font-medium">Sincronizando dados...</p>
                </div>

                <div id="stats-grid" class="hidden grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
                    </div>

                <div id="details-grid" class="hidden grid-cols-1 lg:grid-cols-2 gap-4">
                    
                    <div class="bg-white rounded-2xl p-5 border border-gray-100 shadow-sm h-full">
                        <div class="flex items-center gap-2 mb-5">
                            <i data-lucide="triangle-alert" class="w-5 h-5 text-amber-500"></i>
                            <h3 class="font-semibold text-gray-900">Atenção Necessária</h3>
                        </div>
                        <div class="space-y-3" id="attention-list">
                            </div>
                    </div>

                    <div class="bg-white rounded-2xl p-5 border border-gray-100 shadow-sm h-full">
                        <div class="flex items-center gap-2 mb-5">
                            <i data-lucide="trending-up" class="w-5 h-5 text-emerald-500"></i>
                            <h3 class="font-semibold text-gray-900">Performance</h3>
                        </div>
                        <div class="space-y-5" id="performance-list">
                            </div>
                    </div>

                </div>
            </div>
        </div>
    </main>

    <script type="module">
        import "./firebase.js";

        // Controle do Menu Mobile
        window.toggleMenu = () => {
            const sb = document.getElementById('sidebar');
            const over = document.getElementById('sidebar-overlay');
            const isOpen = !sb.classList.contains('-translate-x-full');
            
            if(isOpen) {
                sb.classList.add('-translate-x-full');
                over.classList.add('hidden');
                document.body.classList.remove('menu-open');
            } else {
                sb.classList.remove('-translate-x-full');
                over.classList.remove('hidden');
                document.body.classList.add('menu-open');
            }
        };

        window.onload = async () => {
            const user = await window.authApi.check();
            if(!user) return;

            // Preencher Sidebar com dados reais
            const role = window.__session.role;
            document.getElementById('user-email').textContent = user.email;
            document.getElementById('user-role-label').textContent = role === 'admin' ? 'Administrador' : 'Líder';
            document.getElementById('user-initial').textContent = user.email.charAt(0).toUpperCase();

            // Carregar dados
            try {
                const members = await window.guildDB.getMembers();
                renderDashboard(members);
            } catch (e) {
                console.error(e);
            }
            lucide.createIcons();
        };

        function renderDashboard(members) {
            const total = members.length;
            const gw = members.filter(m => m.guildWar).length;
            const meta = members.filter(m => m.weeklyMeta).length;
            const tag = members.filter(m => m.hasTag).length;

            const noGw = total - gw;
            const noMeta = total - meta;
            const noTag = total - tag;

            // HTML Helper: Card Principal
            const createCard = (title, value, subtitle, icon, colorInfo) => `
                <div class="bg-white rounded-2xl p-5 border border-gray-100 shadow-sm hover:shadow-md transition-all duration-200 cursor-default group">
                    <div class="flex items-start justify-between mb-3">
                        <div class="w-10 h-10 rounded-xl bg-gradient-to-br ${colorInfo.bg} flex items-center justify-center shadow-lg ${colorInfo.shadow} text-white group-hover:scale-110 transition-transform">
                            <i data-lucide="${icon}" class="w-5 h-5"></i>
                        </div>
                    </div>
                    <div>
                        <p class="text-3xl font-bold text-gray-900">${value}</p>
                        <p class="text-sm text-gray-500 mt-1 font-medium">${title}</p>
                        <p class="text-xs text-gray-400 mt-0.5">${subtitle}</p>
                    </div>
                </div>
            `;

            document.getElementById('stats-grid').innerHTML = `
                ${createCard("Total de Membros", total, "Ativos", "users", {bg: "from-emerald-500 to-green-600", shadow: "shadow-emerald-200"})}
                ${createCard("Guerra de Guilda", gw, `de ${total}`, "swords", {bg: "from-blue-500 to-indigo-600", shadow: "shadow-blue-200"})}
                ${createCard("Meta Semanal", meta, `de ${total}`, "target", {bg: "from-violet-500 to-purple-600", shadow: "shadow-violet-200"})}
                ${createCard("Com Tag", tag, `de ${total}`, "tag", {bg: "from-amber-500 to-orange-600", shadow: "shadow-amber-200"})}
            `;

            // HTML Helper: Lista de Atenção (Igual ao print: fundo colorido claro)
            const createAlert = (label, val, colors) => `
                <div class="flex items-center justify-between p-3.5 ${colors.bg} rounded-xl">
                    <div class="flex items-center gap-3">
                        <div class="w-2 h-2 rounded-full ${colors.dot}"></div>
                        <span class="text-sm font-semibold ${colors.text}">${label}</span>
                    </div>
                    <span class="text-sm font-bold ${colors.text}">${val}</span>
                </div>
            `;

            document.getElementById('attention-list').innerHTML = `
                ${createAlert("Sem Guerra de Guilda", noGw, {bg: "bg-red-50", text: "text-red-700", dot: "bg-red-500"})}
                ${createAlert("Meta Semanal Pendente", noMeta, {bg: "bg-orange-50", text: "text-orange-700", dot: "bg-orange-500"})}
                ${createAlert("Sem Tag", noTag, {bg: "bg-gray-50", text: "text-gray-600", dot: "bg-gray-400"})}
            `;

            // HTML Helper: Barras de Progresso
            const createBar = (label, val, max, gradient) => {
                const pct = max > 0 ? Math.round((val / max) * 100) : 0;
                return `
                <div>
                    <div class="flex items-center justify-between mb-1.5">
                        <span class="text-sm text-gray-600 font-medium">${label}</span>
                        <span class="text-sm font-bold text-gray-900">${pct}%</span>
                    </div>
                    <div class="w-full h-2.5 bg-gray-100 rounded-full overflow-hidden">
                        <div class="h-full bg-gradient-to-r ${gradient} rounded-full transition-all duration-1000 ease-out" style="width: 0%" id="bar-${Math.random().toString(36).substr(2)}"></div>
                    </div>
                </div>`;
            };

            const perfContainer = document.getElementById('performance-list');
            perfContainer.innerHTML = `
                ${createBar("Participação na Guerra", gw, total, "from-emerald-400 to-green-500")}
                ${createBar("Meta Semanal Cumprida", meta, total, "from-violet-400 to-purple-500")}
                ${createBar("Membros com Tag", tag, total, "from-amber-400 to-orange-500")}
            `;

            // Animar as barras após renderizar
            setTimeout(() => {
                const bars = perfContainer.querySelectorAll('[id^="bar-"]');
                const values = [gw, meta, tag];
                bars.forEach((bar, index) => {
                    const pct = total > 0 ? (values[index] / total) * 100 : 0;
                    bar.style.width = `${pct}%`;
                });
            }, 100);

            // Mostrar conteúdo
            document.getElementById('loading').classList.add('hidden');
            document.getElementById('stats-grid').classList.remove('hidden');
            document.getElementById('stats-grid').classList.add('grid');
            document.getElementById('details-grid').classList.remove('hidden');
            document.getElementById('details-grid').classList.add('grid');
            
            lucide.createIcons();
        }
    </script>
</body>
</html>
