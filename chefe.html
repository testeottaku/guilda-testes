<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Chefe - Guilda Hub</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/lucide@latest"></script>
  <link rel="stylesheet" href="./style.css" />
</head>
<body class="bg-gray-50/80">

  <div class="flex min-h-screen">
    <!-- Sidebar Overlay Mobile -->
    <div id="sidebar-overlay" class="fixed inset-0 bg-black/30 z-40 hidden lg:hidden"></div>

    <!-- Sidebar -->
    <aside id="sidebar" class="fixed top-0 left-0 h-full w-72 bg-white border-r border-gray-200 z-50 transform -translate-x-full transition-transform duration-300 lg:translate-x-0 lg:static">
      <div class="flex items-center justify-between p-5 border-b border-gray-100">
        <div class="flex items-center gap-3">
          <div class="w-10 h-10 bg-gradient-to-br from-emerald-500 to-green-600 rounded-xl flex items-center justify-center shadow-lg shadow-green-200 text-white">
            <i data-lucide="shield" class="w-5 h-5"></i>
          </div>
          <div>
            <h1 class="font-bold text-gray-900 text-lg leading-tight">Guilda e eventos</h1>
            <p class="text-xs text-gray-400">Chefe</p>
          </div>
        </div>
      </div>

      <nav class="p-4 space-y-1">
        <a href="dashboard.html" class="w-full flex items-center gap-3 px-4 py-3 rounded-xl text-sm font-medium text-gray-500 hover:bg-gray-50 hover:text-gray-700 transition-colors">
          <i data-lucide="house" class="w-5 h-5"></i> Dashboard
        </a>
        <a href="membros.html" class="w-full flex items-center gap-3 px-4 py-3 rounded-xl text-sm font-medium text-gray-500 hover:bg-gray-50 hover:text-gray-700 transition-colors">
          <i data-lucide="users" class="w-5 h-5"></i> Membros
        </a>
        <a href="lines.html" class="w-full flex items-center gap-3 px-4 py-3 rounded-xl text-sm font-medium text-gray-500 hover:bg-gray-50 hover:text-gray-700 transition-colors">
          <i data-lucide="layers" class="w-5 h-5"></i> Lines
        </a>
        <a href="ajustes.html" class="w-full flex items-center gap-3 px-4 py-3 rounded-xl text-sm font-medium text-gray-500 hover:bg-gray-50 hover:text-gray-700 transition-colors">
          <i data-lucide="sliders" class="w-5 h-5"></i> Ajustes
        </a>
        <a href="upgrade.html" class="w-full flex items-center gap-3 px-4 py-3 rounded-xl text-sm font-medium text-gray-500 hover:bg-gray-50 hover:text-gray-700 transition-colors">
          <i data-lucide="sparkles" class="w-5 h-5"></i> Upgrade
        </a>
        <a href="camp.html" class="only-leader w-full flex items-center gap-3 px-4 py-3 rounded-xl text-sm font-medium text-gray-500 hover:bg-gray-50 hover:text-gray-700 transition-colors">
          <i data-lucide="trophy" class="w-5 h-5"></i> Campeonato
        </a>
        <a href="admin.html" class="only-leader w-full flex items-center gap-3 px-4 py-3 rounded-xl text-sm font-medium text-gray-500 hover:bg-gray-50 hover:text-gray-700 transition-colors">
          <i data-lucide="settings" class="w-5 h-5"></i> Admin
        </a>
        <a id="nav-chefe" href="chefe.html" class="w-full flex items-center gap-3 px-4 py-3 rounded-xl text-sm font-medium bg-emerald-50 text-emerald-700 shadow-sm">
          <i data-lucide="crown" class="w-5 h-5"></i> Chefe
        </a>
      </nav>

      <div class="absolute bottom-0 left-0 right-0 p-4 border-t border-gray-100">
        <div class="flex items-center justify-between px-3 py-2">
          <div class="flex items-center gap-3">
            <div class="w-8 h-8 rounded-full bg-emerald-100 flex items-center justify-center text-emerald-700 font-bold text-sm">A</div>
            <div>
              <p id="user-role" class="text-sm font-medium text-gray-700">Carregando...</p>
              <p id="user-email" class="text-xs text-gray-400 truncate w-24">...</p>
            </div>
          </div>
          <button id="logout-btn" class="text-sm text-gray-400 hover:text-gray-600">Sair</button>
        </div>
      </div>
    </aside>

    <!-- Main -->
    <main class="flex-1 lg:ml-0">
      <header class="sticky top-0 z-30 bg-gray-50/80 backdrop-blur border-b border-gray-200">
        <div class="max-w-5xl mx-auto px-4 py-4 flex items-center gap-3">
          <button id="mobile-menu-btn" class="lg:hidden inline-flex items-center justify-center w-10 h-10 rounded-xl border border-gray-200 bg-white">
            <i data-lucide="menu" class="w-5 h-5"></i>
          </button>
          <div>
            <h2 class="text-lg font-bold text-gray-900">Painel do Chefe</h2>
            <p class="text-xs text-gray-500">Pesquisar guildas, alterar VIP e excluir tudo (com Auth via Cloud Functions).</p>
          </div>
        </div>
      </header>

      <section class="max-w-5xl mx-auto px-4 py-6">
        <div class="bg-white border border-gray-200 rounded-2xl p-5 shadow-sm">
          <div class="flex flex-col sm:flex-row gap-3 sm:items-end">
            <div class="flex-1">
              <label class="block text-xs text-gray-500 mb-1">Pesquisar</label>
              <input id="chefe-query" type="text" placeholder="Nome da guilda OU e-mail de líder/admin" class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:outline-none focus:ring-2 focus:ring-emerald-200" />
              <p class="mt-2 text-xs text-gray-400">Dica: se digitar um e-mail, a busca usa as listas leaders/admins (configGuilda).</p>
            </div>
            <button id="chefe-search" class="px-5 py-3 rounded-xl bg-emerald-600 text-white font-bold hover:bg-emerald-700">Buscar</button>
          </div>
        </div>

        <div class="mt-5 bg-white border border-gray-200 rounded-2xl p-5 shadow-sm">
          <div class="flex items-center justify-between">
            <h3 class="font-bold text-gray-900">Resultado</h3>
            <span id="results-count" class="text-xs text-gray-500">0</span>
          </div>
          <div id="results-preview" class="mt-3 text-sm text-gray-500">Faça uma busca para listar as guildas.</div>
        </div>
      </section>
    </main>
  </div>

  <!-- Modal: Lista -->
  <div id="modal-results" class="hidden fixed inset-0 z-50">
    <div class="absolute inset-0 bg-black/40"></div>
    <div class="relative max-w-3xl mx-auto mt-16 bg-white rounded-2xl shadow-xl border border-gray-200 overflow-hidden">
      <div class="px-5 py-4 border-b border-gray-100 flex items-center justify-between">
        <div>
          <p class="text-xs text-gray-500">Guildas encontradas</p>
          <h4 class="font-bold text-gray-900">Lista</h4>
        </div>
        <button id="modal-close" class="w-10 h-10 rounded-xl border border-gray-200 bg-white hover:bg-gray-50 flex items-center justify-center">
          <i data-lucide="x" class="w-5 h-5"></i>
        </button>
      </div>
      <div id="results-list" class="p-4 space-y-3 max-h-[65vh] overflow-auto"></div>
    </div>
  </div>

  <!-- Modal: Edit VIP -->
  <div id="modal-edit" class="hidden fixed inset-0 z-50">
    <div class="absolute inset-0 bg-black/40"></div>
    <div class="relative max-w-lg mx-auto mt-24 bg-white rounded-2xl shadow-xl border border-gray-200 overflow-hidden">
      <div class="px-5 py-4 border-b border-gray-100 flex items-center justify-between">
        <div>
          <p class="text-xs text-gray-500">Editar plano VIP</p>
          <h4 id="edit-title" class="font-bold text-gray-900">Guilda</h4>
        </div>
        <button id="edit-close" class="w-10 h-10 rounded-xl border border-gray-200 bg-white hover:bg-gray-50 flex items-center justify-center">
          <i data-lucide="x" class="w-5 h-5"></i>
        </button>
      </div>
      <div class="p-5">
        <label class="block text-xs text-gray-500 mb-1">VIP</label>
        <select id="edit-tier" class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:outline-none focus:ring-2 focus:ring-emerald-200">
          <option value="free">free</option>
          <option value="plus">plus</option>
          <option value="pro">pro</option>
          <option value="business">business</option>
        </select>
        <div class="mt-4 flex gap-2">
          <button id="edit-save" class="flex-1 px-5 py-3 rounded-xl bg-emerald-600 text-white font-bold hover:bg-emerald-700">Salvar</button>
          <button id="edit-cancel" class="flex-1 px-5 py-3 rounded-xl bg-gray-100 text-gray-900 font-bold hover:bg-gray-200">Cancelar</button>
        </div>
        <p class="mt-3 text-xs text-gray-400">Business é tratado como Pro nas liberações.</p>
      </div>
    </div>
  </div>

  <!-- Modal: Confirm Delete -->
  <div id="modal-delete" class="hidden fixed inset-0 z-50">
    <div class="absolute inset-0 bg-black/40"></div>
    <div class="relative max-w-lg mx-auto mt-24 bg-white rounded-2xl shadow-xl border border-gray-200 overflow-hidden">
      <div class="px-5 py-4 border-b border-gray-100 flex items-center justify-between">
        <div>
          <p class="text-xs text-gray-500">Excluir guilda + usuários</p>
          <h4 id="delete-title" class="font-bold text-gray-900">Confirmação</h4>
        </div>
        <button id="delete-close" class="w-10 h-10 rounded-xl border border-gray-200 bg-white hover:bg-gray-50 flex items-center justify-center">
          <i data-lucide="x" class="w-5 h-5"></i>
        </button>
      </div>
      <div class="p-5">
        <p class="text-sm text-gray-600">Isso apaga:</p>
        <ul class="mt-2 text-sm text-gray-500 list-disc pl-5 space-y-1">
          <li>guildas/{guildId} + subcoleções (membros, lines)</li>
          <li>configGuilda/{guildId}</li>
          <li>users vinculados à guildId</li>
          <li>contas no Firebase Auth (via Admin SDK/Cloud Function)</li>
        </ul>
        <div class="mt-4 flex gap-2">
          <button id="delete-confirm" class="flex-1 px-5 py-3 rounded-xl bg-rose-600 text-white font-bold hover:bg-rose-700">Deletar tudo</button>
          <button id="delete-cancel" class="flex-1 px-5 py-3 rounded-xl bg-gray-100 text-gray-900 font-bold hover:bg-gray-200">Cancelar</button>
        </div>
        <p class="mt-3 text-xs text-gray-400">Requer Cloud Function deployada. Sem isso, apenas Firestore pode ser apagado.</p>
      </div>
    </div>
  </div>

  <script type="module">
    import { checkAuth, setupSidebar, initIcons, showToast, logout, db, functions, isCeo, ensureCeoStatus } from "./logic.js";
    import { doc, getDoc, query, collection, where, getDocs, limit } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
    import { httpsCallable } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-functions.js";

    setupSidebar();
    initIcons();

    // Protege tela
    await checkAuth();
    await ensureCeoStatus();
    if (!isCeo()) {
      showToast("error", "Acesso negado: somente o Chefe.");
      window.location.href = "dashboard.html";
    }

    document.getElementById("logout-btn")?.addEventListener("click", logout);

    const $ = (id) => document.getElementById(id);
    const modalResults = $("modal-results");
    const modalEdit = $("modal-edit");
    const modalDelete = $("modal-delete");

    const state = {
      items: [],
      selected: null
    };

    function openModal(m){ m?.classList.remove("hidden"); }
    function closeModal(m){ m?.classList.add("hidden"); }

    $("modal-close")?.addEventListener("click", () => closeModal(modalResults));
    $("edit-close")?.addEventListener("click", () => closeModal(modalEdit));
    $("edit-cancel")?.addEventListener("click", () => closeModal(modalEdit));
    $("delete-close")?.addEventListener("click", () => closeModal(modalDelete));
    $("delete-cancel")?.addEventListener("click", () => closeModal(modalDelete));

    function normalizeTier(v){
      const s = (v||"").toString().toLowerCase().trim();
      if (!s || s === "free") return "free";
      if (s === "business" || s.includes("business")) return "business";
      if (s === "pro" || s.includes("pro")) return "pro";
      return "plus";
    }

    async function loadDetails(guildId) {
      const out = { guildId, name: "", ownerEmail: "", vipTier: "free", leaders: [], admins: [] };
      try {
        const g = await getDoc(doc(db, "guildas", guildId));
        if (g.exists()) {
          const d = g.data() || {};
          out.name = (d.name || d.guildName || "").toString();
          if (d.ownerEmail) out.ownerEmail = (d.ownerEmail || "").toString();
          if (d.vipTier || d.vip || d.plan || d.planoVip) out.vipTier = normalizeTier(d.vipTier || d.vip || d.plan || d.planoVip);
        }
      } catch (_) {}

      try {
        const c = await getDoc(doc(db, "configGuilda", guildId));
        if (c.exists()) {
          const d = c.data() || {};
          if (d.ownerEmail) out.ownerEmail = (d.ownerEmail || "").toString();
          out.leaders = Array.isArray(d.leaders) ? d.leaders : [];
          out.admins = Array.isArray(d.admins) ? d.admins : [];
          if (d.vipTier || d.vip || d.plan || d.planoVip) out.vipTier = normalizeTier(d.vipTier || d.vip || d.plan || d.planoVip);
        }
      } catch (_) {}

      return out;
    }

    async function searchGuilds(term) {
      const qRaw = (term || "").toString().trim();
      if (!qRaw) return [];
      const qLower = qRaw.toLowerCase();

      const guildIds = new Set();

      // Busca por e-mail nas listas
      if (qLower.includes("@")) {
        try {
          const q1 = query(collection(db, "configGuilda"), where("leaders", "array-contains", qLower), limit(10));
          const s1 = await getDocs(q1);
          s1.forEach(d => guildIds.add(d.id));
        } catch (_) {}
        try {
          const q2 = query(collection(db, "configGuilda"), where("admins", "array-contains", qLower), limit(10));
          const s2 = await getDocs(q2);
          s2.forEach(d => guildIds.add(d.id));
        } catch (_) {}
        try {
          const q3 = query(collection(db, "configGuilda"), where("ownerEmail", "==", qLower), limit(10));
          const s3 = await getDocs(q3);
          s3.forEach(d => guildIds.add(d.id));
        } catch (_) {}
      } else {
        // Busca por nome (prefixo). Obs: case-sensitive dependendo dos dados.
        try {
          const qn = query(collection(db, "guildas"), where("name", ">=", qRaw), where("name", "<=", qRaw + ""), limit(10));
          const sn = await getDocs(qn);
          sn.forEach(d => guildIds.add(d.id));
        } catch (_) {}
      }

      const ids = Array.from(guildIds).slice(0, 20);
      const items = [];
      for (const gid of ids) {
        items.push(await loadDetails(gid));
      }
      return items;
    }

    function renderList(items) {
      state.items = items;
      $("results-count").textContent = String(items.length);

      if (!items.length) {
        $("results-preview").textContent = "Nenhuma guilda encontrada.";
        return;
      }

      $("results-preview").textContent = "Clique em Buscar novamente para abrir a lista.";

      const list = $("results-list");
      list.innerHTML = "";

      for (const it of items) {
        const leaders = (it.leaders || []).slice(0, 2).join(", ");
        const admins = (it.admins || []).slice(0, 2).join(", ");

        const row = document.createElement("div");
        row.className = "p-4 rounded-2xl border border-gray-200 bg-white shadow-sm";
        row.innerHTML = `
          <div class="flex items-start justify-between gap-3">
            <div class="min-w-0">
              <p class="text-xs text-gray-500">${it.guildId}</p>
              <h5 class="font-bold text-gray-900 truncate">${it.name || "(sem nome)"}</h5>
              <p class="mt-1 text-sm text-gray-600">VIP: <span class="font-bold text-gray-900">${it.vipTier || "free"}</span></p>
              <p class="mt-1 text-xs text-gray-500">Owner: ${it.ownerEmail || "-"}</p>
              <p class="mt-1 text-xs text-gray-400">Leaders: ${leaders || "-"} | Admins: ${admins || "-"}</p>
            </div>
            <div class="flex flex-col sm:flex-row gap-2">
              <button class="btn-edit px-4 py-2 rounded-xl bg-emerald-600 text-white font-bold hover:bg-emerald-700" data-gid="${it.guildId}">
                Editar VIP
              </button>
              <button class="btn-del px-4 py-2 rounded-xl bg-rose-600 text-white font-bold hover:bg-rose-700" data-gid="${it.guildId}">
                Deletar
              </button>
            </div>
          </div>
        `;

        row.querySelector(".btn-edit").addEventListener("click", () => openEdit(it));
        row.querySelector(".btn-del").addEventListener("click", () => openDelete(it));
        list.appendChild(row);
      }
    }

    function openEdit(it) {
      state.selected = it;
      $("edit-title").textContent = it.name || it.guildId;
      $("edit-tier").value = normalizeTier(it.vipTier);
      openModal(modalEdit);
    }

    function openDelete(it) {
      state.selected = it;
      $("delete-title").textContent = `${it.name || it.guildId}`;
      openModal(modalDelete);
    }

    async function callOrFallback(callableName, data, fallbackFn) {
      try {
        const fn = httpsCallable(functions, callableName);
        const res = await fn(data);
        return res?.data || { ok: true };
      } catch (e) {
        if (typeof fallbackFn === "function") return await fallbackFn(e);
        throw e;
      }
    }

    $("edit-save").addEventListener("click", async () => {
      const it = state.selected;
      if (!it) return;
      const vipTier = $("edit-tier").value;

      try {
        $("edit-save").disabled = true;
        await callOrFallback("ceoSetGuildVip", { guildId: it.guildId, vipTier }, async () => {
          // fallback direto no Firestore (requer rules liberando para CEO)
          await updateDoc(doc(db, "configGuilda", it.guildId), { vipTier });
          await updateDoc(doc(db, "guildas", it.guildId), { vipTier });
          return { ok: true, fallback: true };
        });

        showToast("success", "VIP atualizado.");
        closeModal(modalEdit);

        // atualiza item na lista
        it.vipTier = vipTier;
        renderList(state.items);
      } catch (e) {
        showToast("error", "Falha ao atualizar VIP.");
        console.error(e);
      } finally {
        $("edit-save").disabled = false;
      }
    });

    $("delete-confirm").addEventListener("click", async () => {
      const it = state.selected;
      if (!it) return;

      try {
        $("delete-confirm").disabled = true;
        await callOrFallback("ceoDeleteGuild", { guildId: it.guildId }, async () => {
          showToast("error", "Cloud Function não encontrada. Faça deploy das functions para deletar Auth.");
          return { ok: false, needsFunctions: true };
        });

        showToast("success", "Guilda excluída.");
        closeModal(modalDelete);
        closeModal(modalResults);
        $("results-preview").textContent = "Exclusão concluída. Faça nova busca.";
        $("results-count").textContent = "0";
        state.items = [];
      } catch (e) {
        showToast("error", "Falha ao excluir.");
        console.error(e);
      } finally {
        $("delete-confirm").disabled = false;
      }
    });

    async function runSearch() {
      const term = $("chefe-query").value;
      $("chefe-search").disabled = true;
      $("results-preview").textContent = "Buscando...";

      try {
        const items = await searchGuilds(term);
        renderList(items);
        openModal(modalResults);
        try { if (window.lucide && typeof window.lucide.createIcons === "function") window.lucide.createIcons(); } catch (_) {}
      } catch (e) {
        console.error(e);
        showToast("error", "Falha na busca.");
        $("results-preview").textContent = "Falha na busca.";
      } finally {
        $("chefe-search").disabled = false;
      }
    }

    $("chefe-search").addEventListener("click", runSearch);
    $("chefe-query").addEventListener("keydown", (e) => {
      if (e.key === "Enter") runSearch();
    });

  </script>
</body>
</html>
