<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Minhas estatísticas</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: { extend: { colors: { emerald: { 50:'#ecfdf5', 100:'#d1fae5', 200:'#a7f3d0', 400:'#34d399', 500:'#10b981', 600:'#059669', 700:'#047857' } } } }
    }
  </script>
  <script src="https://unpkg.com/lucide@latest"></script>

  <style>
    /* micro UX */
    .reveal { opacity: 0; transform: translateY(18px); filter: blur(2px); transition: opacity .55s ease, transform .55s ease, filter .55s ease; }
    .reveal.show { opacity: 1; transform: translateY(0); filter: blur(0); }

    .btn-spinner{
      width:18px;height:18px;border-radius:999px;border:2px solid rgba(255,255,255,.55);
      border-top-color:rgba(255,255,255,0);display:inline-block;animation:spin .9s linear infinite;
    }
    @keyframes spin{to{transform:rotate(360deg)}}

    /* drawer */
    .drawer-backdrop{ opacity:0; pointer-events:none; transition: opacity .25s ease; }
    .drawer-backdrop.show{ opacity:1; pointer-events:auto; }
    .drawer-panel{ transform: translateX(110%); transition: transform .35s cubic-bezier(.2,.9,.2,1); }
    .drawer-panel.show{ transform: translateX(0); }
  
  .dd { position: relative; }
  .dd-btn { width: 100%; display:flex; align-items:center; justify-content:space-between; gap:.75rem; border-radius: 1rem;
    background: rgba(255,255,255,.9); border:1px solid rgba(15,23,42,.14); padding: .75rem 1rem; font-size: .875rem;
    outline:none; }
  .dd-btn:focus { box-shadow: 0 0 0 4px rgba(16,185,129,.18); border-color: rgba(16,185,129,.55); }
  .dd-menu { position:absolute; left:0; right:0; top: calc(100% + .5rem); background:#0b1220; color:#e2e8f0;
    border:1px solid rgba(255,255,255,.10); border-radius: 1rem; overflow:hidden; z-index:40;
    box-shadow: 0 18px 40px rgba(0,0,0,.22); }
  .dd-item { width:100%; text-align:left; padding:.7rem 1rem; font-size:.875rem; display:flex; align-items:center; gap:.6rem; }
  .dd-item:hover { background: rgba(255,255,255,.06); }
  .dd-item[aria-selected="true"] { background: rgba(16,185,129,.16); color:#d1fae5; }

</style>
</head>
<body class="min-h-screen bg-white text-slate-900">

  
  <div id="sidebar-overlay" class="fixed inset-0 z-40 hidden bg-black/40"></div>
  <aside id="sidebar" class="fixed left-0 top-0 z-50 h-full w-[280px] -translate-x-full bg-white backdrop-blur border-r border-slate-200 transition-transform">
    <div class="p-4 border-b border-slate-200 flex items-center justify-between">
      <div class="flex items-center gap-2">
        <div class="h-9 w-9 rounded-xl bg-emerald-500/15 ring-1 ring-emerald-400/20 flex items-center justify-center">
          <i data-lucide="shield" class="h-5 w-5 text-emerald-700"></i>
        </div>
        <div class="leading-tight">
          <div class="text-slate-900 font-black">Guilda HUB</div>
          <div class="text-xs text-slate-500">Eventos • Camps • Stats</div>
        </div>
      </div>
      <button id="sidebar-close" class="h-10 w-10 grid place-items-center rounded-xl hover:bg-slate-100">
        <i data-lucide="x" class="h-5 w-5 text-slate-700"></i>
      </button>
    </div>

    <nav class="p-3 space-y-1">
      <a href="index.html" class="flex items-center gap-3 px-3 py-2 rounded-xl text-slate-700 hover:bg-slate-100">
        <i data-lucide="home" class="h-4 w-4"></i>
        <span class="font-semibold">Início</span>
      </a>
      <a href="eventos.html" class="flex items-center gap-3 px-3 py-2 rounded-xl text-slate-700 hover:bg-slate-100">
        <i data-lucide="calendar" class="h-4 w-4"></i>
        <span class="font-semibold">Eventos e Camp</span>
      </a>
      <a href="stats.html" class="flex items-center gap-3 px-3 py-2 rounded-xl text-slate-700 hover:bg-slate-100">
        <i data-lucide="bar-chart-3" class="h-4 w-4"></i>
        <span class="font-semibold">Minhas estatísticas</span>
      </a>
      <a href="suporte.html" class="flex items-center gap-3 px-3 py-2 rounded-xl text-slate-700 hover:bg-slate-100">
        <i data-lucide="help-circle" class="h-4 w-4"></i>
        <span class="font-semibold">Suporte</span>
      </a>
    </nav>

    <div class="mt-auto p-4 text-xs text-slate-500 border-t border-white/10">
      <div class="leading-relaxed">Dica: você pode navegar sem login para ver eventos e consultar stats públicas.</div>
    </div>
  </aside>

<header class="sticky top-0 z-30 bg-white/80 backdrop-blur border-b border-slate-200">
    <div class="mx-auto w-full max-w-6xl px-4 py-3 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <button id="sidebar-open" class="h-10 w-10 grid place-items-center rounded-xl bg-white ring-1 ring-slate-200 text-slate-900 shadow-sm hover:bg-slate-50">
          <i data-lucide="menu" class="h-5 w-5"></i>
        </button>
        <div class="leading-tight">
          <div class="font-black text-slate-900">Guilda HUB</div>
          <div class="text-xs text-slate-500">Eventos • Camps • Stats</div>
        </div>
      </div>
      <a href="index.html" class="text-sm font-semibold text-emerald-700 hover:text-emerald-800">Voltar</a>
    </div>
  </header><main class="mx-auto w-full max-w-6xl px-4 py-6">
<section class="space-y-4">
  <div class="rounded-3xl bg-white ring-1 ring-slate-200 p-4">
    <div class="text-sm font-bold">Buscar meu perfil</div>
    <p class="mt-1 text-xs text-slate-500">Digite seu nick ou ID. Não mostramos WhatsApp aqui por segurança.</p>
    <div class="mt-4 flex flex-col gap-3 sm:flex-row">
      <input id="query" type="text" placeholder="Seu nick ou ID"
        class="flex-1 rounded-2xl bg-white ring-1 ring-slate-200 px-4 py-3 text-sm outline-none focus:ring-emerald-400/40" />
      <button id="btnSearch" class="rounded-2xl bg-emerald-600 px-5 py-3 text-sm font-black hover:bg-emerald-700 transition text-white">Buscar</button>
    </div>
    <div id="hint" class="mt-3 text-xs text-slate-500"></div>
  </div>
  <div id="out"></div>
</section>
</main>

<script>
(function(){
  const openBtn = document.getElementById('sidebar-open');
  const closeBtn = document.getElementById('sidebar-close');
  const overlay = document.getElementById('sidebar-overlay');
  const sidebar = document.getElementById('sidebar');
  function open(){
    overlay.classList.remove('hidden');
    sidebar.classList.remove('-translate-x-full');
    document.body.style.overflow='hidden';
  }
  function close(){
    overlay.classList.add('hidden');
    sidebar.classList.add('-translate-x-full');
    document.body.style.overflow='';
  }
  if(openBtn) openBtn.addEventListener('click', open);
  if(closeBtn) closeBtn.addEventListener('click', close);
  if(overlay) overlay.addEventListener('click', close);
  document.addEventListener('keydown', (e)=>{ if(e.key==='Escape') close(); });
})();
</script>

<script>lucide.createIcons();</script>
<script type="module">
import { db, setupSidebar, initIcons } from './logic.js';
import {
  collectionGroup, getDocs, query, limit, doc, getDoc
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

setupSidebar();
initIcons();

// close sidebar
document.getElementById('sidebar-close')?.addEventListener('click', () => {
  document.getElementById('sidebar')?.classList.add('-translate-x-full');
  document.getElementById('sidebar-backdrop')?.classList.add('hidden');
});

const elInp = document.getElementById('query');
const elBtn = document.getElementById('btnSearch');
const elOut = document.getElementById('out');
const elHint = document.getElementById('hint');

const norm = (s) => (s ?? '').toString().trim();
const normLow = (s) => norm(s).toLowerCase();
const esc = (s) => (s ?? '').toString()
  .replace(/&/g,'&amp;').replace(/</g,'&lt;')
  .replace(/>/g,'&gt;').replace(/"/g,'&quot;')
  .replace(/'/g,'&#039;');

function badge(text) {
  return `<span class="inline-flex items-center rounded-full bg-emerald-50 px-3 py-1 text-xs font-semibold text-emerald-700 ring-1 ring-emerald-100">${esc(text)}</span>`;
}

function line(icon, text) {
  if (!text) return '';
  return `<div class="flex items-center gap-3 text-slate-700">
    <div class="h-10 w-10 rounded-2xl bg-emerald-50 ring-1 ring-emerald-100 flex items-center justify-center">
      <i data-lucide="${icon}" class="h-5 w-5 text-emerald-700"></i>
    </div>
    <div class="text-[15px] font-semibold">${esc(String(text))}</div>
  </div>`;
}

async function resolveGuildName(gid, fallbackName="") {
  const tryName = norm(fallbackName);
  if (tryName) return tryName;

  if (!gid) return "Guilda";
  try {
    const g = await getDoc(doc(db, "guildas", gid));
    const d = g.exists() ? (g.data() || {}) : {};
    return norm(d.name || d.nome) || "Guilda";
  } catch (_) {
    return "Guilda";
  }
}

function renderMemberCard(member, guildName) {
  const nick = norm(member.nick) || "Sem nick";
  const visibleId = norm(member.visibleId || member.playerId || member.idJogador || member.id || member.playerID);
  const hasTag = !!member.hasTag;
  const guildWar = !!member.guildWar;
  const weeklyMeta = !!member.weeklyMeta;

  const gwMeta = member.guildWarMeta != null ? Number(member.guildWarMeta) : null;
  const wkMetaVal = member.weeklyMetaValue != null ? Number(member.weeklyMetaValue) : null;

  elOut.innerHTML = `
    <div class="rounded-3xl border border-slate-200 bg-white p-6 shadow-sm">
      <div class="flex items-start justify-between gap-4">
        <div>
          <div class="text-2xl font-extrabold text-slate-900">${esc(nick)}</div>
          <div class="mt-1 text-sm font-semibold text-slate-500">Guilda: <span class="text-slate-700">${esc(guildName)}</span></div>
        </div>
        ${hasTag ? badge("Tem tag") : badge("Sem tag")}
      </div>

      <div class="mt-6 grid gap-3">
        ${line("id-card", visibleId ? `ID do jogador: ${visibleId}` : "ID do jogador: não informado")}
        ${line("swords", `Meta de guerra: ${guildWar ? "BATEU" : "NÃO bateu"}${gwMeta!=null ? ` (meta ${gwMeta})` : ""}`)}
        ${line("bar-chart-3", `Meta semanal: ${weeklyMeta ? "BATEU" : "NÃO bateu"}${wkMetaVal!=null ? ` (meta ${wkMetaVal})` : ""}`)}
      </div>

      <div class="mt-5 text-xs text-slate-500">
        Observação: contato/WhatsApp não é exibido aqui por segurança.
      </div>
    </div>
  `;
  initIcons();
}

let cachedMembers = null;

async function loadMembersCache() {
  if (cachedMembers) return cachedMembers;

  // leitura pública via rules; sem filtros pra não exigir índice
  const snap = await getDocs(query(collectionGroup(db, "membros"), limit(2000)));
  cachedMembers = snap.docs.map(d => {
    const data = d.data() || {};
    const path = d.ref.path || "";
    const m = path.match(/guildas\/([^/]+)\/membros\//);
    const gid = m ? m[1] : (data.guildId || "");
    return { gid, data };
  });
  return cachedMembers;
}

async function doSearch() {
  const q = norm(elInp?.value);
  if (!q) {
    elHint.textContent = "Digite um ID ou nick";
    elOut.innerHTML = "";
    return;
  }

  elHint.textContent = "Buscando…";
  elOut.innerHTML = `<div class="rounded-2xl border border-slate-200 bg-white p-5 text-slate-600">Carregando…</div>`;

  try {
    const list = await loadMembersCache();
    const qLow = normLow(q);

    // prioridade: procurar por visibleId exato
    let hit = list.find(x => norm(x.data.visibleId) === q);

    // fallback: procurar por outros campos de ID comuns
    if (!hit) {
      const idFields = ["playerId","idJogador","id","playerID","visibleID","visId"];
      hit = list.find(x => idFields.some(f => norm(x.data[f]) === q));
    }

    // fallback: procurar nick (contém)
    if (!hit) {
      hit = list.find(x => normLow(x.data.nick).includes(qLow));
    }

    if (!hit) {
      elHint.textContent = "Nada encontrado.";
      elOut.innerHTML = `<div class="rounded-2xl border border-slate-200 bg-white p-5 text-slate-600">Nenhum jogador encontrado.</div>`;
      return;
    }

    const guildName = await resolveGuildName(hit.gid, hit.data.guildName || hit.data.guild || "");
    elHint.textContent = "";
    renderMemberCard(hit.data, guildName);

  } catch (e) {
    console.error("Erro ao buscar stats:", e);
    elHint.textContent = "";
    elOut.innerHTML = `<div class="rounded-2xl border border-red-200 bg-red-50 p-5 text-red-800">Erro ao buscar. Abra o console.</div>`;
  }
}

elBtn?.addEventListener('click', doSearch);
elInp?.addEventListener('keydown', (ev) => {
  if (ev.key === "Enter") doSearch();
});
</script>
</body>
</html>
