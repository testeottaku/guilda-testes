<!DOCTYPE html>

<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>Minhas estatísticas</title>
<link href="global.css" rel="stylesheet"/><script src="https://cdn.tailwindcss.com"></script>

<script src="https://unpkg.com/lucide@latest"></script>

</head>
<body class="min-h-screen bg-white text-slate-900 gh-body">
<div class="fixed inset-0 z-40 hidden bg-black/40" id="sidebar-overlay"></div>
<aside class="fixed left-0 top-0 z-50 h-full w-[280px] -translate-x-full bg-white backdrop-blur border-r border-slate-200 transition-transform" id="sidebar">
<div class="p-4 border-b border-slate-200 flex items-center justify-between">
<div class="flex items-center gap-2">
<div class="h-9 w-9 rounded-xl bg-emerald-500/15 ring-1 ring-emerald-400/20 flex items-center justify-center">
<i class="h-5 w-5 text-emerald-700" data-lucide="shield"></i>
</div>
<div class="leading-tight">
<div class="text-slate-900 font-black">Guilda • HUB</div>
<div class="text-xs text-slate-500">Estatísticas￼</div>
</div>
</div>
<button class="h-10 w-10 grid place-items-center rounded-xl hover:bg-slate-100" id="sidebar-close">
<i class="h-5 w-5 text-slate-700" data-lucide="x"></i>
</button>
</div>
<nav class="p-3 space-y-1">
<a class="flex items-center gap-3 px-3 py-2 rounded-xl text-slate-700 hover:bg-slate-100" href="index.html">
<i class="h-4 w-4" data-lucide="home"></i>
<span class="font-semibold">Início</span>
</a>
<a class="flex items-center gap-3 px-3 py-2 rounded-xl text-slate-700 hover:bg-slate-100" href="eventos.html">
<i class="h-4 w-4" data-lucide="calendar"></i>
<span class="font-semibold">Eventos e Camp</span>
</a>
<a class="flex items-center gap-3 px-3 py-2 rounded-xl text-slate-700 hover:bg-slate-100" href="stats.html">
<i class="h-4 w-4" data-lucide="bar-chart-3"></i>
<span class="font-semibold">Minhas estatísticas</span>
</a>
<a class="flex items-center gap-3 px-3 py-2 rounded-xl text-slate-700 hover:bg-slate-100" href="suporte.html">
<i class="h-4 w-4" data-lucide="help-circle"></i>
<span class="font-semibold">Suporte</span>
</a>
</nav>
<div class="mt-auto p-4 text-xs text-slate-500 border-t border-white/10">
<div class="leading-relaxed">Dica: você pode navegar sem login para ver eventos e consultar stats públicas.</div>
</div>
</aside>
<header class="sticky top-0 z-30 bg-white/80 backdrop-blur border-b border-slate-200">
<div class="mx-auto w-full max-w-6xl px-4 py-3 flex items-center justify-between">
<div class="flex items-center gap-3">
<button class="h-10 w-10 grid place-items-center rounded-xl bg-white ring-1 ring-slate-200 text-slate-900 shadow-sm hover:bg-slate-50" id="sidebar-open">
<i class="h-5 w-5" data-lucide="menu"></i>
</button>
<div class="leading-tight">
<div class="font-black text-slate-900">Guilda • HUB</div>
<div class="text-xs text-slate-500"> Estatísticas￼</div>
</div>
</div>
<a class="text-sm font-semibold text-emerald-700 hover:text-emerald-800" href="index.html">Voltar</a>
</div>
</header><main class="mx-auto w-full max-w-6xl px-4 py-6">
<section class="space-y-4">
<div class="rounded-3xl bg-white ring-1 ring-slate-200 p-4">
<div class="text-sm font-bold">Buscar meu perfil</div>
<p class="mt-1 text-xs text-slate-500">Digite seu nick ou ID para ver suas estatísticas basica.</p>
<div class="mt-4 flex flex-col gap-3 sm:flex-row">
<input class="flex-1 rounded-2xl bg-white ring-1 ring-slate-200 px-4 py-3 text-sm outline-none focus:ring-emerald-400/40" id="query" placeholder="Seu nick ou ID" type="text"/>
<button class="rounded-2xl bg-emerald-600 px-5 py-3 text-sm font-black hover:bg-emerald-700 transition text-white" id="btn">Buscar</button>
</div>
<div class="mt-3 text-xs text-slate-500" id="hint"></div>
</div>
<div id="result"></div>
</section>
</main>
<script>
(function(){
  const openBtn = document.getElementById('sidebar-open');
  const closeBtn = document.getElementById('sidebar-close');
  const overlay = document.getElementById('sidebar-overlay');
  const sidebar = document.getElementById('sidebar');
  function open(){
    overlay.classList.remove('hidden');
    sidebar.classList.remove('-translate-x-full');
    document.body.style.overflow='hidden';
  }
  function close(){
    overlay.classList.add('hidden');
    sidebar.classList.add('-translate-x-full');
    document.body.style.overflow='';
  }
  if(openBtn) openBtn.addEventListener('click', open);
  if(closeBtn) closeBtn.addEventListener('click', close);
  if(overlay) overlay.addEventListener('click', close);
  document.addEventListener('keydown', (e)=>{ if(e.key==='Escape') close(); });
})();
</script>
<script>lucide.createIcons();</script>
<script type="module">

import { db, setupSidebar, initIcons } from './logic.js';
import { collection, getDocs, query, limit } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

setupSidebar();
initIcons();
const __sbClose = document.getElementById('sidebar-close');
__sbClose?.addEventListener('click', () => {
  document.getElementById('sidebar')?.classList.add('-translate-x-full');
  document.getElementById('sidebar-overlay')?.classList.add('hidden');
});


const elInput = document.getElementById('query');
const elBtn = document.getElementById('btn');
const elOut = document.getElementById('result');
const elHint = document.getElementById('hint');

const norm = (v) => (v == null ? '' : String(v)).toLowerCase().trim();
const safeStr = (v) => (v == null ? '' : String(v));

function card(html) {
  elOut.innerHTML = `<div class="rounded-3xl border border-slate-200 bg-white p-5 shadow-sm">${html}</div>`;
}

function escapeHtml(s) {
  return String(s)
    .replaceAll("&", "&amp;")
    .replaceAll("<", "&lt;")
    .replaceAll(">", "&gt;")
    .replaceAll('"', "&quot;")
    .replaceAll("'", "&#039;");
}

async function findMemberPublic(term) {
  const q = norm(term);
  if (!q) return null;

  // Sem collectionGroup: varre guildas e procura em membros.
  const gSnap = await getDocs(query(collection(db, "guildas"), limit(250)));
  const guilds = gSnap.docs.map(d => ({ id: d.id, data: d.data() || {} }));

  for (const g of guilds) {
    const gid = g.id;
    const gname = (g.data.name || g.data.nome || "").toString().trim() || "Guilda";
    try {
      const mSnap = await getDocs(query(collection(db, "guildas", gid, "membros"), limit(2000)));
      for (const m of mSnap.docs) {
        const d = m.data() || {};
        const nick = norm(d.nick || d.nickname || d.nickName || d.nome || d.name || d.playerNick || d.playerName || d.tag || d.tagName);
        const pid  = norm(d.visibleId || d.playerId || d.id || d.uid || d.gameId || d.idff || d.idFF || d.freeFireId || d.ffId || d.idFreeFire || d.idJogo || d.idDoJogo);
        const alt  = norm(d.idPlayer || d.idJogador || d.player || d.usuario || d.userId);
        const email = norm(d.email || d.mail);

        if (q === nick || q === pid || q === alt || q === norm(m.id) || (q && (nick.includes(q) || pid.includes(q) || alt.includes(q) || email.includes(q)))) {
          return { guildId: gid, guildName: gname, id: m.id, data: d };
        }
      }
    } catch (_) {}
  }

  return null;
}

function renderMember(res) {
  const d = res.data || {};
  const guildName = safeStr(res.guildName || d.guildName || "Guilda");
  const nick = safeStr(d.nick || d.nickname || d.nome || d.name || "—");

  // ✅ ID do jogador (pelo seu Firestore: visibleId)
  const playerId = safeStr(
    d.visibleId || d.playerId || d.idJogador || d.idPlayer || d.idJogo || d.idDoJogo ||
    d.gameId || d.idff || d.idFF || d.freeFireId || d.ffId || d.idFreeFire || res.id || "—"
  );

  const playModeRaw = d.playMode;
  const playMode = (playModeRaw == null || String(playModeRaw).trim() === '') ? '—' : String(playModeRaw).trim();

  const hasTag = (d.hasTag === true) || !!(d.tag && String(d.tag).trim());
  const guildWarOk = (d.guildWar === true);
  const weeklyOk = (d.weeklyMeta === true);

  const guildWarMeta = (d.guildWarMeta != null ? String(d.guildWarMeta) : "");
  const weeklyMetaValue = (d.weeklyMetaValue != null ? String(d.weeklyMetaValue) : "");

  const yesNoPill = (ok) =>
    ok
      ? `<span class="inline-flex items-center rounded-full bg-emerald-50 px-2.5 py-1 text-xs font-black text-emerald-700 ring-1 ring-emerald-100">Sim</span>`
      : `<span class="inline-flex items-center rounded-full bg-slate-100 px-2.5 py-1 text-xs font-black text-slate-700 ring-1 ring-slate-200">Não</span>`;

  card(`
    <div class="flex items-start justify-between gap-3">
      <div class="min-w-0">
        <div class="text-lg font-black text-slate-900 truncate">${escapeHtml(nick)}</div>
        <div class="mt-1 text-xs text-slate-500">Guilda: <span class="font-semibold">${escapeHtml(guildName)}</span></div>
        <div class="mt-1 text-sm text-slate-700">ID do jogador: <span class="font-extrabold">${escapeHtml(playerId)}</span></div>
      </div>
      <div class="h-11 w-11 rounded-2xl bg-emerald-600 text-white grid place-items-center shadow-sm shrink-0">
        <i data-lucide="user" class="h-5 w-5"></i>
      </div>
    </div>

    <div class="mt-5 grid gap-3 sm:grid-cols-2">
      <div class="rounded-2xl border border-slate-200 bg-white p-4">
        <div class="text-xs text-slate-500">Tem tag?</div>
        <div class="mt-2">${yesNoPill(hasTag)}</div>
      </div>

      <div class="rounded-2xl border border-slate-200 bg-white p-4">
        <div class="text-xs text-slate-500">Modo de jogo</div>
        <div class="mt-2">
          <span class="inline-flex items-center rounded-full bg-white px-2.5 py-1 text-xs font-black text-slate-800 ring-1 ring-slate-200">${escapeHtml(playMode)}</span>
        </div>
      </div>

      <div class="rounded-2xl border border-slate-200 bg-white p-4">
        <div class="text-xs text-slate-500">Bateu meta de guerra?</div>
        <div class="mt-2 flex items-center gap-2">
          ${yesNoPill(guildWarOk)}
          ${guildWarMeta ? `<span class="text-xs text-slate-500">Meta: <span class="font-bold text-slate-700">${escapeHtml(guildWarMeta)}</span></span>` : ``}
        </div>
      </div>

      <div class="rounded-2xl border border-slate-200 bg-white p-4 sm:col-span-2">
        <div class="text-xs text-slate-500">Bateu meta semanal?</div>
        <div class="mt-2 flex items-center gap-2">
          ${yesNoPill(weeklyOk)}
          ${weeklyMetaValue ? `<span class="text-xs text-slate-500">Meta: <span class="font-bold text-slate-700">${escapeHtml(weeklyMetaValue)}</span></span>` : ``}
        </div>
      </div>
    </div>

    <div class="mt-4 text-xs text-slate-500">
      Observação: O nick que aparece aqui é o nick que o seu lider da guilda cadastrou em nossa plataforma.
    </div>
  `);

  try { initIcons(); } catch (_) {}
}


async function run() {
  const term = (elInput?.value || "").trim();
  if (!term) {
    elHint.textContent = "Digite um ID ou nick.";
    return;
  }
  elHint.textContent = "Buscando…";
  elOut.innerHTML = `<div class="rounded-3xl border border-slate-200 bg-white p-5 text-slate-600">Carregando…</div>`;
  try {
    const res = await findMemberPublic(term);
    if (!res) {
      elHint.textContent = "Não encontrei esse jogador ainda.";
      elOut.innerHTML = `<div class="rounded-3xl border border-slate-200 bg-white p-5 text-slate-600">Nada encontrado.</div>`;
      return;
    }
    elHint.textContent = "";
    renderMember(res);
  } catch (e) {
    console.error(e);
    elHint.textContent = "Erro ao buscar. Abra o console.";
    elOut.innerHTML = `<div class="rounded-3xl border border-red-200 bg-red-50 p-5 text-red-800">Erro ao buscar.</div>`;
  }
}

elBtn?.addEventListener('click', run);
elInput?.addEventListener('keydown', (e)=>{ if(e.key==='Enter') run(); });

</script>
</body>
</html>
