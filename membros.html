<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Membros</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
</head>
<body class="bg-gray-50 flex text-gray-800 font-sans">

    <aside class="w-64 bg-white border-r h-screen fixed hidden lg:block">
        <div class="p-6 flex items-center gap-3 border-b">
            <div class="bg-emerald-500 text-white p-2 rounded-lg"><i data-lucide="shield"></i></div>
            <span class="font-bold">Painel Guilda</span>
        </div>
        <nav class="p-4 space-y-2">
            <a href="dashboard.html" class="flex gap-3 px-4 py-3 text-gray-500 hover:bg-gray-100 rounded-xl transition">
                <i data-lucide="layout-dashboard"></i> Dashboard
            </a>
            <a href="membros.html" class="flex gap-3 px-4 py-3 bg-emerald-50 text-emerald-700 rounded-xl font-medium">
                <i data-lucide="users"></i> Membros
            </a>
            <button onclick="window.authApi.logout().then(()=>location.href='index.html')" class="w-full flex gap-3 px-4 py-3 text-red-500 hover:bg-red-50 rounded-xl mt-10">
                <i data-lucide="log-out"></i> Sair
            </button>
        </nav>
    </aside>

    <main class="flex-1 lg:ml-64 min-h-screen">
        <header class="bg-white/80 backdrop-blur border-b p-4 sticky top-0 z-10 flex justify-between items-center">
            <h1 class="font-bold text-lg">Gerenciar Membros</h1>
            <button onclick="openModal()" class="bg-emerald-500 text-white px-4 py-2 rounded-xl text-sm font-bold hover:bg-emerald-600 flex gap-2">
                <i data-lucide="plus" class="w-4 h-4"></i> Novo
            </button>
        </header>

        <div class="p-6 max-w-5xl mx-auto space-y-4">
            <input type="text" id="search" placeholder="Buscar membro..." class="w-full p-3 rounded-xl border focus:ring-2 focus:ring-emerald-500 outline-none">
            <div id="list" class="space-y-3">
                <p class="text-center text-gray-400 py-10">Carregando...</p>
            </div>
        </div>
    </main>

    <div id="modal" class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white w-full max-w-md rounded-2xl overflow-hidden shadow-2xl animate-in fade-in zoom-in duration-200">
            <div class="p-4 border-b flex justify-between bg-gray-50">
                <h3 class="font-bold">Detalhes do Membro</h3>
                <button onclick="document.getElementById('modal').classList.add('hidden')"><i data-lucide="x" class="w-5 h-5 text-gray-500"></i></button>
            </div>
            <form id="formMember" class="p-5 space-y-4">
                <input type="hidden" id="mid">
                
                <div>
                    <label class="text-xs font-bold text-gray-500">ID do Jogo</label>
                    <div class="flex gap-2">
                        <input type="text" id="uid" class="flex-1 p-2 border rounded-lg" required>
                        <button type="button" onclick="fetchApi()" class="px-3 bg-emerald-100 text-emerald-700 rounded-lg text-xs font-bold">Buscar</button>
                    </div>
                </div>

                <div>
                    <label class="text-xs font-bold text-gray-500">Nick</label>
                    <input type="text" id="nick" class="w-full p-2 border rounded-lg" required>
                </div>

                <div>
                    <label class="text-xs font-bold text-gray-500">WhatsApp</label>
                    <input type="text" id="zap" class="w-full p-2 border rounded-lg">
                </div>

                <div class="grid grid-cols-2 gap-4 pt-2">
                    <label class="flex items-center gap-2 text-sm">
                        <input type="checkbox" id="gw" class="accent-emerald-500 w-4 h-4"> Guerra
                    </label>
                    <input type="number" id="gwVal" class="p-1 border rounded text-sm" placeholder="Valor">

                    <label class="flex items-center gap-2 text-sm">
                        <input type="checkbox" id="meta" class="accent-emerald-500 w-4 h-4"> Meta Semanal
                    </label>
                    <input type="number" id="metaVal" class="p-1 border rounded text-sm" placeholder="Valor">
                </div>

                <label class="flex items-center gap-2 text-sm pt-2">
                    <input type="checkbox" id="tag" class="accent-emerald-500 w-4 h-4"> Possui Tag da Guilda
                </label>

                <div class="pt-4 flex gap-2">
                    <button type="button" id="btnDelete" class="hidden flex-1 py-2 bg-red-100 text-red-600 rounded-xl font-bold">Excluir</button>
                    <button type="submit" class="flex-1 py-2 bg-emerald-500 text-white rounded-xl font-bold">Salvar</button>
                </div>
            </form>
        </div>
    </div>

    <script type="module">
        import "./firebase.js";
        let cache = [];

        window.onload = async () => {
            if(!await window.authApi.check()) return;
            load();
        };

        async function load() {
            cache = await window.guildDB.getMembers();
            render(cache);
        }

        function render(arr) {
            const div = document.getElementById('list');
            div.innerHTML = "";
            arr.forEach(m => {
                const el = document.createElement('div');
                el.className = "bg-white p-4 rounded-xl border shadow-sm flex items-center justify-between hover:shadow-md cursor-pointer transition";
                el.onclick = () => openModal(m);
                el.innerHTML = `
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 rounded-full bg-emerald-100 flex items-center justify-center text-emerald-700 font-bold">${m.nick[0]}</div>
                        <div>
                            <p class="font-bold text-sm">${m.nick}</p>
                            <p class="text-xs text-gray-400">ID: ${m.visibleId || m.id}</p>
                        </div>
                    </div>
                    <div class="flex gap-2 text-gray-400">
                        ${m.guildWar ? '<i data-lucide="swords" class="w-4 h-4 text-blue-500"></i>' : ''}
                        ${m.weeklyMeta ? '<i data-lucide="target" class="w-4 h-4 text-violet-500"></i>' : ''}
                        <i data-lucide="chevron-right" class="w-4 h-4"></i>
                    </div>
                `;
                div.appendChild(el);
            });
            lucide.createIcons();
        }

        // Filtro de Busca
        document.getElementById('search').oninput = (e) => {
            const txt = e.target.value.toLowerCase();
            render(cache.filter(m => m.nick.toLowerCase().includes(txt) || (m.visibleId||"").includes(txt)));
        };

        // Modal Logic
        window.openModal = (m = null) => {
            const f = document.getElementById('formMember');
            f.reset();
            document.getElementById('btnDelete').classList.add('hidden');
            
            if(m) {
                document.getElementById('mid').value = m.id;
                document.getElementById('uid').value = m.visibleId || "";
                document.getElementById('nick').value = m.nick;
                document.getElementById('zap').value = m.whatsapp || "";
                document.getElementById('gw').checked = m.guildWar;
                document.getElementById('gwVal').value = m.guildWarMeta || 0;
                document.getElementById('meta').checked = m.weeklyMeta;
                document.getElementById('metaVal').value = m.weeklyMetaValue || 0;
                document.getElementById('tag').checked = m.hasTag;
                
                const btnDel = document.getElementById('btnDelete');
                btnDel.classList.remove('hidden');
                btnDel.onclick = async () => {
                    if(confirm("Excluir membro?")) {
                        await window.guildDB.deleteMember(m.id);
                        document.getElementById('modal').classList.add('hidden');
                        load();
                    }
                };
            }
            document.getElementById('modal').classList.remove('hidden');
        };

        // Salvar
        document.getElementById('formMember').onsubmit = async (e) => {
            e.preventDefault();
            const id = document.getElementById('mid').value || Date.now().toString();
            const data = {
                id: id,
                visibleId: document.getElementById('uid').value,
                nick: document.getElementById('nick').value,
                whatsapp: document.getElementById('zap').value,
                guildWar: document.getElementById('gw').checked,
                guildWarMeta: Number(document.getElementById('gwVal').value),
                weeklyMeta: document.getElementById('meta').checked,
                weeklyMetaValue: Number(document.getElementById('metaVal').value),
                hasTag: document.getElementById('tag').checked
            };
            try {
                await window.guildDB.saveMember(data);
                document.getElementById('modal').classList.add('hidden');
                load();
            } catch(err) { alert("Erro ao salvar"); }
        };

        // API Mitsuri (Exatamente como pediu)
        window.fetchApi = async () => {
            const uid = document.getElementById('uid').value;
            if(!uid) return;
            try {
                const req = await fetch("https://api.mitsuri.fun/api/trpc/api.info", {
                    method:"POST", headers:{"Content-Type":"application/json"},
                    body:JSON.stringify({json:{key:"mitsuri_UVPRYNm5RNdvirmjrMQqlu8XVpEpFPxP", uid:uid, region:"BR"}})
                });
                const res = await req.json();
                const d = res?.result?.data?.json;
                if(d?.nickname) document.getElementById('nick').value = d.nickname;
                else alert("Jogador n√£o encontrado");
            } catch(e) { alert("Erro na API"); }
        };
    </script>
</body>
</html>
