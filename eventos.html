<!DOCTYPE html>

<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>Eventos e Camp</title>
<link href="global.css" rel="stylesheet"/><script src="https://cdn.tailwindcss.com"></script>

<script src="https://unpkg.com/lucide@latest"></script>

</head>
<body class="min-h-screen bg-white text-slate-900 gh-body">
<div class="fixed inset-0 z-40 hidden bg-black/40" id="sidebar-overlay"></div>
<aside class="fixed left-0 top-0 z-50 h-full w-[280px] -translate-x-full bg-white backdrop-blur border-r border-slate-200 transition-transform" id="sidebar">
<div class="p-4 border-b border-slate-200 flex items-center justify-between">
<div class="flex items-center gap-2">
<div class="h-9 w-9 rounded-xl bg-emerald-500/15 ring-1 ring-emerald-400/20 flex items-center justify-center">
<i class="h-5 w-5 text-emerald-700" data-lucide="shield"></i>
</div>
<div class="leading-tight">
<div class="text-slate-900 font-black">Guilda • HUB</div>
<div class="text-xs text-slate-500">Eventos • Camps</div>
</div>
</div>
<button class="h-10 w-10 grid place-items-center rounded-xl hover:bg-slate-100" id="sidebar-close">
<i class="h-5 w-5 text-slate-700" data-lucide="x"></i>
</button>
</div>
<nav class="p-3 space-y-1">
<a class="flex items-center gap-3 px-3 py-2 rounded-xl text-slate-700 hover:bg-slate-100" href="index.html">
<i class="h-4 w-4" data-lucide="home"></i>
<span class="font-semibold">Início</span>
</a>
<a class="flex items-center gap-3 px-3 py-2 rounded-xl text-slate-700 hover:bg-slate-100" href="eventos.html">
<i class="h-4 w-4" data-lucide="calendar"></i>
<span class="font-semibold">Eventos e Camp</span>
</a>
<a class="flex items-center gap-3 px-3 py-2 rounded-xl text-slate-700 hover:bg-slate-100" href="stats.html">
<i class="h-4 w-4" data-lucide="bar-chart-3"></i>
<span class="font-semibold">Minhas estatísticas</span>
</a>
<a class="flex items-center gap-3 px-3 py-2 rounded-xl text-slate-700 hover:bg-slate-100" href="suporte.html">
<i class="h-4 w-4" data-lucide="help-circle"></i>
<span class="font-semibold">Suporte</span>
</a>
</nav>
<div class="mt-auto p-4 text-xs text-slate-500 border-t border-white/10">
<div class="leading-relaxed">Dica: você pode navegar sem login para ver eventos e consultar stats públicas.</div>
</div>
</aside>
<header class="sticky top-0 z-30 bg-white/80 backdrop-blur border-b border-slate-200">
<div class="mx-auto w-full max-w-6xl px-4 py-3 flex items-center justify-between">
<div class="flex items-center gap-3">
<button class="h-10 w-10 grid place-items-center rounded-xl bg-white ring-1 ring-slate-200 text-slate-900 shadow-sm hover:bg-slate-50" id="sidebar-open">
<i class="h-5 w-5 text-slate-900" data-lucide="menu"></i>
</button>
<div class="leading-tight">
<div class="font-black text-slate-900">Guilda • HUB</div>
<div class="text-xs text-slate-500">Eventos • Camps</div>
</div>
</div>
<a class="text-sm font-semibold text-emerald-700 hover:text-emerald-800" href="index.html">Voltar</a>
</div>
</header>
<main class="mx-auto w-full max-w-6xl px-4 py-6">
<section class="space-y-4">
<div class="flex flex-col gap-3 sm:flex-row sm:items-end sm:justify-between">
<div class="flex-1">
<label class="text-xs text-slate-500">Pesquisar</label>
<input class="mt-1 w-full rounded-2xl bg-white ring-1 ring-slate-200 px-4 py-3 text-sm outline-none focus:ring-emerald-400/40" id="q" placeholder="Ex: nome da guilda, título, descrição..." type="text"/>
</div>
<div class="w-full sm:w-[280px]">
<label class="text-xs text-slate-500">Filtro</label>
<div class="relative mt-1">
<input id="filter" type="hidden" value="all"/>
<div class="dd">
<button class="dd-btn" id="filterBtn" type="button">
<span class="font-semibold text-slate-900" id="filterLabel">Todos</span>
<i class="h-4 w-4 text-slate-600" data-lucide="chevron-down"></i>
</button>
<div class="dd-menu hidden" id="filterMenu">
<button aria-selected="true" class="dd-item" data-value="all" type="button"><i class="h-4 w-4" data-lucide="layers"></i>Todos</button>
<button class="dd-item" data-value="br" type="button"><i class="h-4 w-4" data-lucide="zap"></i>Battle Royale</button>
<button class="dd-item" data-value="xvx" type="button"><i class="h-4 w-4" data-lucide="swords"></i>XvX (1v1, 2v2...)</button>
<button class="dd-item" data-value="paid" type="button"><i class="h-4 w-4" data-lucide="badge-dollar-sign"></i>Pago</button>
<button class="dd-item" data-value="free" type="button"><i class="h-4 w-4" data-lucide="leaf"></i>Gratuito</button>
<button class="dd-item" data-value="prize" type="button"><i class="h-4 w-4" data-lucide="trophy"></i>Com premiação</button>
<button class="dd-item" data-value="solo" type="button"><i class="h-4 w-4" data-lucide="user"></i>Solo</button>
<button class="dd-item" data-value="duo" type="button"><i class="h-4 w-4" data-lucide="users"></i>Duo</button>
<button class="dd-item" data-value="squad" type="button"><i class="h-4 w-4" data-lucide="users-2"></i>Squad</button>
<button class="dd-item" data-value="1v1" type="button"><i class="h-4 w-4" data-lucide="swords"></i>1v1</button>
<button class="dd-item" data-value="2v2" type="button"><i class="h-4 w-4" data-lucide="swords"></i>2v2</button>
<button class="dd-item" data-value="3v3" type="button"><i class="h-4 w-4" data-lucide="swords"></i>3v3</button>
<button class="dd-item" data-value="4v4" type="button"><i class="h-4 w-4" data-lucide="swords"></i>4v4</button>
</div>
</div>
<i class="pointer-events-none absolute right-3 top-1/2 -translate-y-1/2 h-4 w-4 text-slate-500" data-lucide="chevron-down"></i>
</div>
</div>
</div>
<div class="text-sm text-slate-500" id="status"></div>
<div class="grid grid-cols-1 gap-4 sm:grid-cols-2 lg:grid-cols-3" id="grid"></div>
</section>
</main>
<script>
(function(){
  const openBtn = document.getElementById('sidebar-open');
  const closeBtn = document.getElementById('sidebar-close');
  const overlay = document.getElementById('sidebar-overlay');
  const sidebar = document.getElementById('sidebar');
  function open(){
    overlay.classList.remove('hidden');
    sidebar.classList.remove('-translate-x-full');
    document.body.style.overflow='hidden';
  }
  function close(){
    overlay.classList.add('hidden');
    sidebar.classList.add('-translate-x-full');
    document.body.style.overflow='';
  }
  if(openBtn) openBtn.addEventListener('click', open);
  if(closeBtn) closeBtn.addEventListener('click', close);
  if(overlay) overlay.addEventListener('click', close);
  document.addEventListener('keydown', (e)=>{ if(e.key==='Escape') close(); });
})();
</script>
<script>lucide.createIcons();</script>
<script type="module">

import { db, initIcons } from './logic.js';
import { collection, getDocs, query, limit } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

initIcons();

const elGrid = document.getElementById('grid');
const elStatus = document.getElementById('status');
const elQ = document.getElementById('q');
const elFilter = document.getElementById('filter');

const ddBtn = document.getElementById('filterBtn');
const ddMenu = document.getElementById('filterMenu');
const ddLabel = document.getElementById('filterLabel');

let allItems = [];

const safeStr = (v) => (v == null ? '' : String(v));
const norm = (v) => safeStr(v).toLowerCase().trim();

function setStatus(msg = "") {
  if (!elStatus) return;
  elStatus.textContent = msg;
}

function toggleMenu(forceOpen = null) {
  const open = forceOpen != null ? !!forceOpen : ddMenu.classList.contains('hidden');
  ddMenu.classList.toggle('hidden', !open);
}

ddBtn?.addEventListener('click', () => toggleMenu());
document.addEventListener('click', (e) => {
  if (!ddMenu || !ddBtn) return;
  const inDd = ddMenu.contains(e.target) || ddBtn.contains(e.target);
  if (!inDd) toggleMenu(false);
});
ddMenu?.addEventListener('click', (e) => {
  const btn = e.target.closest('[data-value]');
  if (!btn) return;
  const v = btn.getAttribute('data-value') || 'all';
  elFilter.value = v;

  ddMenu.querySelectorAll('[data-value]').forEach(x => x.setAttribute('aria-selected', 'false'));
  btn.setAttribute('aria-selected', 'true');

  ddLabel.textContent = btn.textContent.trim();
  toggleMenu(false);
  applyFilters();
  try { initIcons(); } catch (_) {}
});

function moneyBRL(v) {
  const n = Number(v);
  if (!isFinite(n) || n <= 0) return null;
  try {
    return new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(n);
  } catch {
    return `R$ ${n.toFixed(2).replace('.', ',')}`;
  }
}



function statusPt(raw) {
  const s = norm(raw).replace(/\s+/g,'_');
  const map = {
    upcoming: "PROXIMO",
    open: "ABERTO",
    opened: "ABERTO",
    active: "ABERTO",
    scheduled: "AGENDADO",
    schedule: "AGENDADO",
    soon: "EM BREVE",
    in_progress: "EM ANDAMENTO",
    running: "EM ANDAMENTO",
    live: "EM ANDAMENTO",
    ongoing: "EM ANDAMENTO",
    closed: "ENCERRADO",
    finished: "FINALIZADO",
    completed: "FINALIZADO",
    cancel: "CANCELADO",
    cancelled: "CANCELADO",
    canceled: "CANCELADO"
  };
  if (!s) return "";
  return map[s] || map[s.toLowerCase()] || raw.toString().toUpperCase();
}

function fmtDateTime(v) {
  if (v == null || v === "") return "";
  // aceita ms number, Timestamp-like, ou string
  try {
    if (typeof v === "number" && isFinite(v)) return new Date(v).toLocaleString("pt-BR");
    if (typeof v === "string") {
      const n = Number(v);
      if (isFinite(n) && n > 0 && v.trim().length >= 10) return new Date(n).toLocaleString("pt-BR");
      // tenta ISO / dd/mm
      const d = new Date(v);
      if (!isNaN(d.getTime())) return d.toLocaleString("pt-BR");
    }
    if (typeof v === "object" && v.seconds) return new Date(v.seconds*1000).toLocaleString("pt-BR");
  } catch(_) {}
  return safeStr(v);
}


function getTypeFlags(d) {
  const mode = norm(d.mode || d.modo || d.brMode);
  const matchup = norm(d.matchup || d.xvx || d.partida || d.duelo);
  const kind = norm(d.kind || d.tipo || d.type || d.format);

  const isBR = kind === 'br' || kind === 'battle' || kind.includes('battle') || ['solo','duo','squad'].includes(mode);
  const isXVX = kind === 'xvx' || matchup.includes('v') || ['1v1','2v2','3v3','4v4'].includes(matchup);

  const fee = Number(d.feeValue ?? d.fee ?? d.taxa ?? d.inscricao ?? 0);
  const isPaid = !!(d.isPaid === true || norm(d.feeType) === 'paid' || fee > 0);
  const hasPrize = Number(d.prizeTotal ?? d.premiacao ?? d.premio ?? 0) > 0;

  return { isBR, isXVX, mode, matchup, isPaid, hasPrize };
}

function matchFilter(d, f) {
  if (f === 'all') return true;
  const t = getTypeFlags(d);
  if (f === 'br') return t.isBR && !t.isXVX;
  if (f === 'xvx') return t.isXVX;
  if (f === 'paid') return t.isPaid;
  if (f === 'free') return !t.isPaid;
  if (f === 'prize') return t.hasPrize;
  if (['solo','duo','squad'].includes(f)) return t.mode === f;
  if (['1v1','2v2','3v3','4v4'].includes(f)) return t.matchup === f;
  return true;
}

function matchQuery(item, q) {
  if (!q) return true;
  const hay = [
    item.title, item.description, item.guildName,
    item.raw?.title, item.raw?.titulo, item.raw?.name
  ].map(norm).join(' ');
  return hay.includes(q);
}

function tag(text, cls = "bg-slate-100 text-slate-700 ring-1 ring-slate-200") {
  return `<span class="inline-flex items-center rounded-full px-2.5 py-1 text-xs font-extrabold ${cls}">${text}</span>`;
}

function render(items) {
  if (!elGrid) return;

  if (!items.length) {
    elGrid.innerHTML = `<div class="col-span-full rounded-2xl border border-slate-200 bg-white p-5 text-slate-600">
      Nenhum evento encontrado com esse filtro/pesquisa.
    </div>`;
    return;
  }

  const pick = (obj, keys, fallback="") => {
    for (const k of keys) {
      const v = obj?.[k];
      if (v !== undefined && v !== null && String(v).trim() !== "") return v;
    }
    return fallback;
  };

  const iconPill = (ico, text) => `
    <span class="inline-flex items-center gap-1.5 rounded-full bg-slate-50 px-2.5 py-1 text-xs font-extrabold text-slate-700 ring-1 ring-slate-200">
      <i data-lucide="${ico}" class="h-3.5 w-3.5"></i>${text}
    </span>`;

  const row = (ico, label, value) => {
    if (!value) return '';
    return `<div class="flex items-center gap-2 text-xs text-slate-600">
      <i data-lucide="${ico}" class="h-4 w-4 text-slate-500"></i>
      <span class="font-semibold text-slate-700">${label}:</span>
      <span class="truncate">${safeStr(value)}</span>
    </div>`;
  };

  elGrid.innerHTML = items.map((it) => {
    const d = it.raw || {};
    const t = getTypeFlags(d);

    const title = safeStr(it.title || "Evento");
    const guildName = safeStr(it.guildName || "Guilda");
    const desc = safeStr(it.description || "");

    const link = safeStr(pick(d, ["link","destino","url","contactLink","infoLink"], "")).trim();

    const location = safeStr(pick(d, ["location","local","place","map","cidade"], "")).trim();

    const drops = pick(d, ["drops","quedas"], "");
    const max = pick(d, ["max","maxPlayers","maxTeams","limite","qtd","teams","equipes"], "");
    const modeTxt = t.isXVX ? (t.matchup || "XvX") : (t.mode || "BR");

    const feeType = norm(pick(d, ["feeType","taxaTipo","inscricaoTipo"], ""));
    const feeValueRaw = pick(d, ["feeValue","fee","taxa","inscricao","valorInscricao"], "");
    const feeValueNum = Number(feeValueRaw);
    const isPaid = (feeType === "paid") || (isFinite(feeValueNum) && feeValueNum > 0) || t.isPaid;
    const feeText = isPaid ? (moneyBRL(feeValueNum) || `R$ ${safeStr(feeValueRaw)}`) : "Gratuito";

    const prize = moneyBRL(pick(d, ["prizeTotal","premiacao","premio","prize"], ""));

    const b64 = safeStr(pick(d, ["photoBase64","fotoBase64","imageBase64","bannerBase64","foto","imagem"], "")).trim();
    const thumb = (() => {
      if (b64) {
        const src = b64.startsWith("data:") ? b64 : `data:image/jpeg;base64,${b64}`;
        return `<img src="${src}" alt="Evento" class="h-14 w-14 rounded-2xl object-cover ring-1 ring-slate-200 bg-slate-100" loading="lazy" />`;
      }
      const ico = safeStr(pick(d, ["icon","icone","symbol"], "")).trim();
      const useIco = ico ? ico : (isPaid ? "badge-dollar-sign" : "trophy");
      return `<div class="h-14 w-14 rounded-2xl bg-emerald-600/10 ring-1 ring-emerald-500/20 grid place-items-center">
        <i data-lucide="${useIco}" class="h-6 w-6 text-emerald-700"></i>
      </div>`;
    })();

    const statusRaw = pick(d, ["progress","progresso","status","andamento"], "");
const statusShow = statusRaw ? statusPt(statusRaw) : "";

const whenRaw = pick(d, ["dateTime","datetime","when","dataHora","data_hora","date","data","hora","time","startAt","startsAt","scheduledAtMs","scheduledAt","startMs"], "");
const whenShow = fmtDateTime(whenRaw);

const topPills = [
  iconPill("users", guildName),
  statusShow ? iconPill("activity", statusShow) : "",
  whenShow ? iconPill("calendar", whenShow) : "",
  prize ? iconPill("trophy", `Premiação ${prize}`) : ""
].filter(Boolean).join("");

    return `<article class="group overflow-hidden rounded-3xl border border-slate-200 bg-white shadow-sm transition hover:shadow-md">
      <div class="p-5">
        <div class="flex items-start justify-between gap-3">
          <div class="flex items-start gap-3 min-w-0">
            ${thumb}
            <div class="min-w-0">
              <div class="truncate text-base font-black text-slate-900">${title}</div>
              <div class="text-xs text-slate-500">Por <span class="font-semibold text-slate-700">${guildName}</span></div>
            </div>
          </div>
          ${link ? `<a href="${link}" target="_blank" rel="noopener noreferrer"
            class="shrink-0 inline-flex items-center gap-2 rounded-2xl bg-slate-900 px-3 py-2 text-xs font-extrabold text-white shadow-sm transition hover:bg-slate-800">
            Ver <i data-lucide="arrow-right" class="h-4 w-4"></i>
          </a>` : ``}
        </div>

        ${desc ? `<p class="mt-3 text-sm text-slate-600 leading-relaxed clamp2">${desc}</p>` : ``}

        <div class="mt-3 flex flex-wrap gap-2 justify-start text-left">
          ${topPills}
        </div>

        <div class="mt-4 grid grid-cols-1 gap-2">
          ${row(t.isXVX ? "swords" : "zap", "Modo", modeTxt.toUpperCase())}
          ${row("badge-dollar-sign", "Inscrição", feeText)}
          ${row("map-pin", "Local", location)}
          ${!t.isXVX ? row("repeat", "Quedas", drops) : ``}
          ${row("users-2", t.isXVX ? "Equipes" : "Participantes", max)}
        </div>

        ${!link ? `<div class="mt-3 text-xs text-slate-400">Sem link de informações</div>` : ``}
      </div>
    </article>`;
  }).join('');

  try { initIcons(); } catch (_) {}
}

function applyFilters() {
  const q = norm(elQ?.value || "");
  const f = norm(elFilter?.value || "all");
  const filtered = allItems.filter(it => matchFilter(it.raw || {}, f) && matchQuery(it, q));
  render(filtered);
}

elQ?.addEventListener('input', applyFilters);

async function loadEventsFromGuildas() {
  setStatus("Carregando eventos…");
  elGrid.innerHTML = `<div class="col-span-full rounded-2xl border border-slate-200 bg-white p-5 text-slate-600">
    Carregando…
  </div>`;

  const items = [];
  try {
    const gSnap = await getDocs(query(collection(db, "guildas"), limit(250)));
    const guilds = gSnap.docs.map(d => ({ id: d.id, data: d.data() || {} }));

    for (const g of guilds) {
      const gid = g.id;
      const gname = (g.data.name || g.data.nome || "").toString().trim() || "Guilda";
      try {
        const cSnap = await getDocs(query(collection(db, "guildas", gid, "campeonatos"), limit(200)));
        for (const c of cSnap.docs) {
          const data = c.data() || {};
          const title = (data.title || data.titulo || data.name || data.nome || "Evento").toString().trim();
          const description = (data.description || data.descricao || "").toString().trim();
          const guildName = (data.guildName || data.guild || gname || "Guilda").toString().trim();
          const createdAtMs = Number(data.createdAtMs ?? data.updatedAtMs ?? 0) || 0;

          items.push({
            id: c.id,
            guildId: gid,
            guildName,
            title,
            description,
            dateText: createdAtMs ? new Date(createdAtMs).toLocaleString('pt-BR') : "",
            raw: data
          });
        }
      } catch (_) {}
    }

    items.sort((a,b) => (b.raw?.createdAtMs||0) - (a.raw?.createdAtMs||0));
    allItems = items;
    setStatus(items.length ? `${items.length} eventos encontrados` : "Nenhum evento encontrado ainda.");
    applyFilters();
  } catch (e) {
    console.error(e);
    setStatus("Não foi possível carregar os eventos. Verifique as regras/coleções.");
    elGrid.innerHTML = `<div class="col-span-full rounded-2xl border border-red-200 bg-red-50 p-5 text-red-800">
      Erro ao carregar eventos. Abra o console para ver detalhes.
    </div>`;
  }
}

loadEventsFromGuildas();

</script>
</body>
</html>
