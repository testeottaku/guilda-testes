<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Guilda</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
</head>
<body class="bg-gray-50 flex text-gray-800 font-sans">

    <div class="lg:hidden fixed top-4 left-4 z-50">
        <button id="btn-logout" class="w-full flex gap-3 px-4 py-3 text-red-500 hover:bg-red-50 rounded-xl mt-10"><i data-lucide="log-out"></i> Sair</button>
        </nav>
    </aside>

    <main class="flex-1 lg:ml-64 min-h-screen p-6">
        <header class="bg-white/80 backdrop-blur border-b p-4 mb-6 rounded-2xl sticky top-0 z-30">
            <h1 class="font-bold text-lg">Configurações de Acesso</h1>
        </header>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 max-w-5xl mx-auto">
            
            <div class="bg-white p-6 rounded-2xl border shadow-sm">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="font-bold text-gray-900 flex gap-2"><i data-lucide="crown" class="text-yellow-500"></i> Administradores</h3>
                    <button onclick="add('admins')" class="text-xs bg-emerald-100 text-emerald-700 px-3 py-1 rounded-lg font-bold hover:bg-emerald-200">Adicionar</button>
                </div>
                <p class="text-xs text-gray-400 mb-4">Acesso total ao sistema.</p>
                <ul id="list-admins" class="space-y-2"></ul>
            </div>

            <div class="bg-white p-6 rounded-2xl border shadow-sm">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="font-bold text-gray-900 flex gap-2"><i data-lucide="medal" class="text-blue-500"></i> Líderes</h3>
                    <button onclick="add('leaders')" class="text-xs bg-emerald-100 text-emerald-700 px-3 py-1 rounded-lg font-bold hover:bg-emerald-200">Adicionar</button>
                </div>
                <p class="text-xs text-gray-400 mb-4">Acesso de visualização e edição de membros.</p>
                <ul id="list-leaders" class="space-y-2"></ul>
            </div>

        </div>
    </main>

    <script type="module">
  import { checkAuth, showToast, logout, auth, db, ensureUserAccount } from "./logic.js";
  import { doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
  import { fetchSignInMethodsForEmail } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

  // Mobile menu
  const menuBtn = document.getElementById("menu-btn");
  const sidebar = document.getElementById("sidebar");
  if (menuBtn && sidebar) {
    menuBtn.onclick = () => sidebar.classList.toggle("-translate-x-full");
  }

  document.getElementById("btn-logout")?.addEventListener("click", logout);

  let securityData = { admins: [], leaders: [] };

  // Só Líder acessa essa tela (a regra já está no checkAuth do logic.js)
  checkAuth().then(async (user) => {
    if (!user) return;
    await load();
  });

  async function load() {
    const snap = await getDoc(doc(db, "guildConfig", "security"));
    securityData = snap.exists() ? (snap.data() || { admins: [], leaders: [] }) : { admins: [], leaders: [] };

    securityData.admins = Array.isArray(securityData.admins) ? securityData.admins : [];
    securityData.leaders = Array.isArray(securityData.leaders) ? securityData.leaders : [];

    renderList("admins", securityData.admins);
    renderList("leaders", securityData.leaders);

    lucide.createIcons();
  }

  function renderList(type, list) {
    const ul = document.getElementById(`list-${type}`);
    ul.innerHTML = "";
    if (!list.length) {
      ul.innerHTML = "<li class='text-sm text-gray-300 italic'>Nenhum usuário</li>";
      return;
    }

    list.forEach((email) => {
      const li = document.createElement("li");
      li.className = "flex justify-between items-center bg-gray-50 p-3 rounded-xl text-sm border";
      li.innerHTML = `
        <span class="truncate pr-2">${escapeHtml(email)}</span>
        <button data-email="${escapeHtml(email)}" class="btn-remove text-red-400 hover:text-red-600">
          <i data-lucide="trash-2" class="w-4 h-4"></i>
        </button>
      `;
      ul.appendChild(li);
    });

    ul.querySelectorAll(".btn-remove").forEach((btn) => {
      btn.addEventListener("click", async () => {
        const email = btn.getAttribute("data-email") || "";
        await remove(type, email);
      });
    });
  }

  function escapeHtml(str="") {
    return String(str)
      .replaceAll("&", "&amp;")
      .replaceAll("<", "&lt;")
      .replaceAll(">", "&gt;")
      .replaceAll('"', "&quot;")
      .replaceAll("'", "&#039;");
  }

  window.add = async (type) => {
    try {
      const email = prompt("Digite o e-mail do usuário:");
      if (!email) return;

      const cleanEmail = email.toLowerCase().trim();
      if (!cleanEmail.includes("@")) {
        showToast("error", "E-mail inválido.");
        return;
      }

      if (!securityData[type]) securityData[type] = [];
      if (securityData[type].includes(cleanEmail)) {
        showToast("info", "Esse e-mail já está na lista.");
        return;
      }

      // Se a conta não existir, cria (sem derrubar seu login)
      const methods = await fetchSignInMethodsForEmail(auth, cleanEmail);
      let created = false;

      if (!methods || methods.length === 0) {
        const pass = prompt("Conta não existe. Defina uma senha (mín. 6):");
        if (!pass) {
          showToast("error", "Senha obrigatória para criar a conta.");
          return;
        }
        const pass2 = prompt("Confirme a senha:");
        if (pass2 !== pass) {
          showToast("error", "As senhas não conferem.");
          return;
        }

        const res = await ensureUserAccount(cleanEmail, pass);
        created = !!res?.created;
      }

      // Salva permissão no Firestore
      securityData[type].push(cleanEmail);
      await save();

      if (created) showToast("success", "Conta criada e acesso liberado.");
      else showToast("success", "Acesso liberado.");

    } catch (e) {
      showToast("error", e?.message || "Erro ao adicionar.");
      console.error(e);
    }
  };

  async function remove(type, email) {
    try {
      if (!confirm(`Remover acesso de ${email}?`)) return;
      securityData[type] = (securityData[type] || []).filter((e) => e !== email);
      await save();
      showToast("success", "Acesso removido.");
    } catch (e) {
      showToast("error", e?.message || "Erro ao remover.");
    }
  }

  async function save() {
    await setDoc(doc(db, "guildConfig", "security"), securityData, { merge: true });
    await load();
  }
</script>